import{D as se}from"./_vuedraggable-a473ce37.js";import{ai as y,aT as _,aF as ne,aK as ue,by as de,c as B,W as a,bD as t,aX as g,o as w,U as i,b9 as j,F as ie,aV as re,H as L,bi as V,I as ce,a as q}from"./_@vue-5ba92de9.js";import"./__vendor-5e6ac033.js";const fe={class:"roadui_draggable_item"},me={class:"dialog-footer"},be={__name:"organize",props:{query:{type:String,default:()=>""}},setup(M){const v=y("ajax"),s=y("utils"),k=y("qs"),R=y("ElSelectorg"),S=y("openPage"),h=y("updateTreeNode"),W=y("getTreeNode"),x=_("");localStorage.getItem("sobInfo")!=""&&(x.value=JSON.parse(localStorage.getItem("sobInfo")));const z=M,n=_(!1);let m=s.query("organizeid",z.query);const U=_(!1),b=_(""),O=_(null),o=_({id:"",name:"",type:"",status:"",note:"",CompanyItems:[],sobItems:[]}),$={name:[{required:!0,message:"请输入名称",trigger:"blur"}],type:[{required:!0,message:"请选择类型",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"blur"}]},N={},A=(l,e)=>{l&&(N[e]=l)};ne(()=>{document.body.ondrop=function(l){try{l.preventDefault(),l.stopPropagation()}catch{}},E()}),ue(()=>{document.body.ondrop=null}),de(()=>z.query,l=>{m=s.query("organizeid",l),E()});const E=()=>{s.length(m)>0&&v.post("/Organize/Get?organizeid="+m).then(l=>{if(l.code==-1){s.msg("未找到组织架构！",l.success);return}o.value=l.data;for(let e=0;e<l.data.workroleItems.length;e++){let d=N[l.data.workroleItems[e].key];s.isDef(d)&&d.initTitle(l.data.workroleItems[e].members)}}).catch(()=>{})},P=()=>{if(!s.isUndef(o.value)){for(let l=0;l<o.value.workroleItems.length;l++)o.value.workroleItems[l].members="";o.value={id:o.value.id,parentId:o.value.parentId,status:0,workRole:"",workroleItems:o.value.workroleItems},b.value=""}},F=async(l,e)=>{l&&await l.validate(d=>{d&&s.confirm("您确定要保存"+(e===1?"为下级":"")+"吗？",()=>{n.value=!0,o.value.workRole=JSON.stringify(o.value.workroleItems),v.post("/Organize/Save?organizeid="+(m||"")+"&savetype="+(e||0)+"&srcorgid="+x.value.id,k.stringify(o.value)).then(p=>{n.value=!1;let c=p.msg;if(s.length(c)===0&&(c=p.code==1?"数据验证错误！":p.success?"保存成功！":"保存失败！"),s.msg(c,p.success),p.success){const f=W(o.value.id),r=s.isDef(f)&&f.isLeaf,T=e===1&&!r?o.value.id:o.value.parentId;h(T,r?o.value.id:"")}}).catch(()=>{n.value=!1})})})},J=()=>{s.confirm("此操作将会删除该组织及其所有下级组织，您确定要删除吗？",()=>{n.value=!0,v.post("/Organize/Delete",k.stringify({organizeid:o.value.id})).then(l=>{let e=l.msg;s.length(e)===0&&(l.success?e="删除成功！":e=l.code==-1?"不能删除组织架构根！":"删除失败！"),s.msg(e,l.success),l.success&&(h(o.value.parentId),S({type:-1},"")),n.value=!1}).catch(()=>{n.value=!1})})},G=()=>{S({id:"",type:4},"?userid=&organizeid="+m+"&organizetype="+o.value.type+"&isadd=1&returnurl="+encodeURIComponent(z.query))},H=()=>{if(s.length(b.value)===0){s.msg("请选择要移动到的组织！",!1);return}s.confirm("您确定要移动吗？",()=>{n.value=!0,v.post("/Organize/MoveTo",k.stringify({organizeid:m,moveto:b.value})).then(l=>{let e=l.msg;s.length(e)===0&&(l.code==0?e="移动成功！":l.code==1?e="要移动的组织为空！":l.code==2&&(e="不能移动到自己或自己的下级组织！")),s.msg(e,l.success),n.value=!1,l.success&&(h(o.value.parentId),h(b.value,b.value),b.value="")}).catch(()=>{n.value=!1})})},I=_(!1),C=_([]),K=()=>{v.post("/Organize/LoadChilds?organizeid="+m).then(l=>{if(!l.success||s.length(l.data)<=1){s.msg(s.length(l.data)===0?"当前组织没有下级组织，勿需排序！如要对人员排序，请点击人员！":"当前组织只有一个下级组织，勿需排序！如要对人员排序，请点击人员！",!1),showSortModal=!1;return}C.value=l.data,I.value=!0}).catch(()=>{})},X=()=>{let l=[];for(let e=0;e<C.value.length;e++)l.push(C.value[e].id);n.value=!0,v.post("/Organize/SaveSort?organizeid="+o.value.id,k.stringify({organizes:l.join(",")})).then(e=>{let d=e.msg;s.length(d)===0&&(d=e.success?"保存成功！":"保存失败！"),s.msg(d,e.success),e.success&&(I.value=!1,h(o.value.id)),n.value=!1}).catch(()=>{n.value=!1})},Q=()=>{S({type:0},"?organizeid="+m+"&organizetype="+o.value.type+"&returnurl="+encodeURIComponent(z.query))},Y=()=>{s.confirm("您确定要同步整个组织架构到企业微信吗？",()=>{n.value=!0,v.post("/Organize/SyncToWeChat").then(l=>{let e=l.code==0?"同步完成！":"同步失败！";s.msg(e,l.success),n.value=!1}).catch(()=>{n.value=!1})})},Z=y("config"),ee=l=>l.name.substr(l.name.lastIndexOf("."))!==".xlsx"?(s.msg("要导入的文件必须是xlsx格式文件!",!1),!1):!0,le=(l,e)=>{if(e.status==="success"){if(l.code!=0){s.msg("文件上传失败！",!1);return}const p=l.data.id;v.post("/Organize/ImportUser?srcorgid="+x.value.id,k.stringify({files:p,deptId:m})).then(c=>{let f=c.msg;s.length(f)===0&&(c.success?(f="导入成功！",h(m)):c.code==1?f="要导入的文件不存在！":f="导入失败！"),s.msg(f,c.success)}).catch(()=>{})}else e.status==="error"&&s.msg("文件上传失败！",!1)};return(l,e)=>{const d=g("el-form-item"),p=g("el-input"),c=g("el-radio"),f=g("el-radio-group"),r=g("el-button"),T=g("el-upload"),ae=g("el-space"),te=g("el-form"),oe=g("el-dialog");return w(),B("div",null,[a(te,{model:o.value,ref_key:"ruleFormRef",ref:O,rules:$,"label-width":"100px"},{default:t(()=>[a(d,{label:"组织id",class:"roadui_formfont"},{default:t(()=>[i(j(o.value.id),1)]),_:1}),a(d,{label:"名称",prop:"name"},{default:t(()=>[a(p,{modelValue:o.value.name,"onUpdate:modelValue":e[0]||(e[0]=u=>o.value.name=u),clearable:""},null,8,["modelValue"])]),_:1}),a(d,{label:"类型",prop:"type"},{default:t(()=>[a(f,{modelValue:o.value.type,"onUpdate:modelValue":e[1]||(e[1]=u=>o.value.type=u)},{default:t(()=>[a(c,{label:1},{default:t(()=>[i("单位")]),_:1}),a(c,{label:2},{default:t(()=>[i("部门")]),_:1}),a(c,{label:3},{default:t(()=>[i("岗位")]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"状态",prop:"status"},{default:t(()=>[a(f,{modelValue:o.value.status,"onUpdate:modelValue":e[2]||(e[2]=u=>o.value.status=u)},{default:t(()=>[a(c,{label:0},{default:t(()=>[i("正常")]),_:1}),a(c,{label:1},{default:t(()=>[i("冻结")]),_:1})]),_:1},8,["modelValue"])]),_:1}),(w(!0),B(ie,null,re(o.value.workroleItems,u=>(w(),L(d,{key:u.key,label:u.title,prop:"note"},{default:t(()=>[a(V(R),{modelValue:u.members,"onUpdate:modelValue":D=>u.members=D,ref_for:!0,ref:D=>A(D,u.key),style:{width:"600px"},clearable:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]))),128)),a(d,{label:"备注",prop:"note"},{default:t(()=>[a(p,{modelValue:o.value.note,"onUpdate:modelValue":e[3]||(e[3]=u=>o.value.note=u),clearable:""},null,8,["modelValue"])]),_:1}),a(d,{label:"导入人员",prop:"note"},{default:t(()=>[a(T,{action:V(Z).SERVER_WEBADDRESS+"/Files/SaveFiles","show-file-list":!1,accept:".xlsx",headers:{"nroadflow-token":V(s).getToken()},"with-credentials":"",data:{filetype:".xlsx",uploadtype:0},"on-success":le,"before-upload":ee},{default:t(()=>[a(r,{type:"primary"},{default:t(()=>[i("选择文件")]),_:1})]),_:1},8,["action","headers","data"])]),_:1}),U.value?(w(),L(d,{key:0,label:"移动到"},{default:t(()=>[a(V(R),{modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=u=>b.value=u),"select-type":"unit,dept,station",placeholder:"请选择要移动到的组织","multiple-limit":1,style:{width:"500px","margin-right":"12px"},clearable:""},null,8,["modelValue"]),a(r,{type:"primary",disabled:n.value,onClick:H},{default:t(()=>[i("确定移动")]),_:1},8,["disabled"])]),_:1})):ce("",!0),a(d,{label:""},{default:t(()=>[a(ae,{wrap:""},{default:t(()=>[a(r,{type:"primary",disabled:n.value,onClick:P},{default:t(()=>[i("清空")]),_:1},8,["disabled"]),a(r,{type:"primary",disabled:n.value,onClick:e[5]||(e[5]=u=>F(O.value,0))},{default:t(()=>[i("保存")]),_:1},8,["disabled"]),a(r,{type:"primary",disabled:n.value,onClick:e[6]||(e[6]=u=>F(O.value,1))},{default:t(()=>[i("保存为下级")]),_:1},8,["disabled"]),a(r,{type:"primary",disabled:n.value,onClick:G},{default:t(()=>[i("添加人员")]),_:1},8,["disabled"]),a(r,{type:"danger",disabled:n.value,onClick:J},{default:t(()=>[i("删除")]),_:1},8,["disabled"]),a(r,{type:"warning",disabled:n.value,onClick:e[7]||(e[7]=u=>U.value=!U.value)},{default:t(()=>[i("移动")]),_:1},8,["disabled"]),a(r,{type:"info",disabled:n.value,onClick:K},{default:t(()=>[i("下级排序")]),_:1},8,["disabled"]),a(r,{type:"primary",disabled:n.value,onClick:Q},{default:t(()=>[i("菜单授权")]),_:1},8,["disabled"]),a(r,{disabled:n.value,onClick:Y},{default:t(()=>[i("同步到企微")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["model"]),a(oe,{modelValue:I.value,"onUpdate:modelValue":e[9]||(e[9]=u=>I.value=u),title:"排序","align-center":"","destroy-on-close":"",width:"550px",draggable:"","close-on-click-modal":!1},{footer:t(()=>[q("span",me,[a(r,{disabled:n.value,type:"primary",onClick:X},{default:t(()=>[i("保存")]),_:1},8,["disabled"]),a(r,{disabled:n.value,onClick:e[8]||(e[8]=u=>I.value=!1)},{default:t(()=>[i("关闭")]),_:1},8,["disabled"])])]),default:t(()=>[a(V(se),{list:C.value,"item-key":"id",animation:200,group:{name:"orgsort",pull:!0},class:"roadui_draggable_chosen"},{item:t(({element:u})=>[q("div",fe,[q("div",null,j(u.name),1)])]),_:1},8,["list"])]),_:1},8,["modelValue"])])}}};export{be as default};
