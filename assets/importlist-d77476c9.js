import{a as ke,_ as na}from"./index-823f4b27.js";import{d as sa,aT as o,ai as x,aF as ia,by as ra,c as E,a as s,W as t,bD as n,bF as Ne,H as C,b9 as S,aX as u,aY as ua,aP as da,aM as ca,aN as J,o as p,U as g,F as Q,aV as re,I as W,bi as Ve,Y as ze}from"./_@vue-5ba92de9.js";import"./__vendor-5e6ac033.js";import"./_@element-plus-ad4c9002.js";import"./_crypto-js-0812dcff.js";import"./_element-plus-8c7ce171.js";import"./_@popperjs-c75af06c.js";import"./_pdfjs-dist-c04561eb.js";import"./_@microsoft-43c4e133.js";import"./_vue-codemirror-50da885a.js";const X=A=>(da("data-v-0d88d10b"),A=A(),ca(),A),va={class:"form-container"},pa={class:"table-container"},ga={class:"table-text"},fa={border:"0",class:"table",style:{position:"relative"},width:"900"},ma={width:"300",align:"center"},ba={width:"300",align:"center"},_a={width:"300",align:"left"},ha={class:"roadui_pagerdiv"},wa=X(()=>s("div",null,[s("h3",{class:"before"},"发票明细")],-1)),ya={class:"table-container"},xa={class:"roadui_pagerdiv"},Ta={style:{margin:"auto",width:"80%"}},Ca={style:{"margin-top":"10px"}},ka=X(()=>s("span",null,"正在开票中",-1)),Na={style:{"margin-top":"10px",margin:"10px auto",display:"flex","justify-content":"space-around"}},Va={class:"successfa"},za=X(()=>s("div",{style:{display:"inline-flex","align-items":"center","font-size":"14px"}}," 已开票 ",-1)),Ia={class:"errorfa"},Sa=X(()=>s("div",{style:{display:"inline-flex","align-items":"center","font-size":"14px"}}," 开票失败 ",-1)),Da=sa({__name:"importlist",props:{query:{type:String,default:()=>""}},setup(A){const Ie=ze(()=>ke(()=>import("./taskEdit-249c23b5.js"),["./taskEdit-249c23b5.js","./_@vue-5ba92de9.js","./__vendor-5e6ac033.js","./__vendor-693c365c.css","./index-823f4b27.js","./_@element-plus-ad4c9002.js","./_crypto-js-0812dcff.js","./_element-plus-8c7ce171.js","./_@popperjs-c75af06c.js","./_element-plus-7d03f811.css","./_pdfjs-dist-c04561eb.js","./_@microsoft-43c4e133.js","./_vue-codemirror-50da885a.js","./index-2ccff9e2.css","./taskEdit-c1526f24.css"],import.meta.url)),Se=ze(()=>ke(()=>import("./importExcel-45862df8.js"),["./importExcel-45862df8.js","./excel-1d8df660.js","./__vendor-5e6ac033.js","./_@vue-5ba92de9.js","./__vendor-693c365c.css","./_element-plus-8c7ce171.js","./_@element-plus-ad4c9002.js","./_@popperjs-c75af06c.js","./_element-plus-7d03f811.css"],import.meta.url)),B=o(!1),L=o(!1),k=x("ajax"),b=x("utils");x("config");const N=x("qs");x("index_openmenu"),x("index_removetab");const K=x("index_refreshtab");x("submit_dialogshow");const ue=o("");localStorage.getItem("sobInfo")!=""&&(ue.value=JSON.parse(localStorage.getItem("sobInfo")));const de=o({prop:"serialNo",order:"ascending"}),De=o({prop:"goodsLineNo",order:"ascending"}),r=o(b.getPager(de.value)),d=o(b.getPager(De.value)),c=o(!1),_=o(!1),D=o(!1),h=o(!1),M=o(!1),$=o(""),Z=o(""),ee=o(""),ae=o(""),le=o(""),te=o(""),oe=o(""),V=o(),ce=o([]),Ue=x("index_userinfo"),R=o({id:"",invoicedepartmentid:""}),Y=o(!1),O=o(!1),ve=o("导入开票列表"),ne=o(0),f=o(0),m=o(0);ia(async()=>{await z(),await Ge()});const w=o([]),T=o(0),U=o(0),P=o(0),Pe=o([{prop:"serialNo",label:"开票流水号",align:"center",width:"200"},{prop:"buyerName",label:"客户名称",align:"center",width:"250"},{prop:"buyerTaxNo",label:"税号",align:"center",width:"200"},{prop:"invoiceTotalPriceTax",label:"价税合计",align:"right",width:"100"},{prop:"invoiceTotalTax",label:"税额",align:"center",width:"110"},{prop:"invoiceTypeName",label:"发票类型",align:"center",width:"130"},{prop:"invoiceDate",label:"开票日期",align:"center",width:"180"},{prop:"invoiceNo",label:"发票号",align:"center",width:"220"}]),Fe=o([{prop:"id",align:"center",show:!1},{prop:"goodsLineNo",label:"序号",align:"center",show:!0,width:"60"},{prop:"goodsCode",label:"商品编号",show:!0,align:"center",width:"200"},{prop:"goodsName",label:"商品名称",show:!0,align:"center",width:"160"},{prop:"goodsSpecification",label:"规格型号",show:!0,align:"center",width:"180"},{prop:"goodsUnit",label:"单位",show:!0,align:"center",width:"100"},{prop:"goodsQuantity",label:"数量",show:!0,align:"center",width:"120"},{prop:"goodsPrice",label:"单价",show:!0,align:"center",width:"120"},{prop:"goodsTotalPrice",label:"价税合计",show:!0,align:"right",width:"120"},{prop:"notaxamount",label:"无税金额",show:!0,align:"right",width:"120"},{prop:"goodsTaxRate",label:"税率/征收率",show:!0,align:"center",width:"150"},{prop:"goodsTotalTax",label:"税额",show:!0,align:"center"}]),Ee=a=>{w.value=Array.from(new Set(a.map(e=>e.id)))},se=o([]),pe=o([]),i=o({serino:"",customername:"",invoiceDate:"",status:""});async function z(){try{D.value=!0,h.value=!0,c.value=!0,_.value=!0,i.value.size=r.value.size,i.value.number=r.value.number,i.value.order=r.value.order,i.value.invoicedepartmentid=V.value,i.value.data1=i.value.invoiceDate[0],i.value.data2=i.value.invoiceDate[1],i.value.type="未开票";const a=await k.post("/Invoice/GetList?srcorgid="+ue.value.id,N.stringify(i.value));if(a.data.rows.length>0){D.value=!1,h.value=!1,c.value=!1,_.value=!1,se.value=a.data.rows,ne.value=a.data.total,$.value=a.data.rows[0].id,r.value.total=a.data.total,f.value=0,m.value=0;for(let e=0;e<a.data.rows.length;e++)f.value=Number((f.value+Number(a.data.rows[e].invoiceTotalPriceTax)).toFixed(2)),m.value=Number((m.value+Number(a.data.rows[e].invoiceTotalTax)).toFixed(2));F()}else{D.value=!1,h.value=!1,c.value=!1,_.value=!1,se.value=a.data.rows,ne.value=a.data.total,$.value="0",r.value.total=a.data.total;for(let e=0;e<a.data.rows.length;e++)f.value=Number((f.value+Number(a.data.rows[e].invoiceTotalPriceTax)).toFixed(2)),m.value=Number((m.value+Number(a.data.rows[e].invoiceTotalTax)).toFixed(2));F()}}catch{c.value=!1,_.value=!1,D.value=!1,h.value=!1}finally{}}const ge=o({}),F=async()=>{h.value=!0,c.value=!0,_.value=!0,ge.value={id:$.value,size:d.value.size,number:d.value.number,order:d.value.order};try{const a=await k.post("/Invoice/GetInvoiceDetailMain",N.stringify(ge.value));a.data.rows.length>0&&(h.value=!1,c.value=!1,_.value=!1,pe.value=a.data.rows),d.value.total=a.data.total}catch{h.value=!1,c.value=!1,_.value=!1}finally{h.value=!1,c.value=!1,_.value=!1}},Ae=a=>{switch(a){case"开票完成":return"success";case"待开票":return"danger";case"已开票待返回电子版":return"warning";default:return"info"}},Be=(a,e)=>{a!=null&&($.value=a.id,d.value.number=1,F())},Le=()=>{M.value=!0},Me=()=>{m.value=0,f.value=0,r.value.number=1,z(),M.value=!1},$e=()=>{m.value=0,f.value=0,i.value={serino:"",customername:"",invoiceDate:"",status:""},z()},Re=()=>{i.value={serino:"",customername:"",invoiceDate:"",status:""}},Ye=a=>{b.confirm("确定要删除吗？",()=>{k.post("/Invoice/DeleteAll",N.stringify({id:a})).then(e=>{const v=e.success?"success":"error";b.msg(e.msg,v,!1),e.success&&K()}).catch(e=>{})})},Oe=async()=>{if(w.value==""){b.msg("请选择要开票的数据","warning",!1);return}Y.value=!0,R.value.invoicedepartmentid=V.value;for(let a=0;a<w.value.length;a++){R.value.id=w.value[a];try{await je()}catch{b.msg("开票失败","error",!1),P.value++}}};ra(T,a=>{U.value=Math.floor((T.value+P.value)/Number(w.value.length)*100),T.value>0,U.value===100&&setTimeout(()=>{Y.value=!1},800)});const je=async()=>{const a=await k.post("/Invoice/a",N.stringify(R.value));a.code==0?(T.value++,b.notify("第"+T.value+"张",a.msg,"success")):(P.value++,b.notify("",a.msg,"error"))},qe=()=>{w.value=w.value.filter(a=>a!==R.value.id)},Ge=async()=>{try{const a=await k.post("user/GetUserInvoiceDepartByUser",N.stringify({userid:Ue.value.userId}));a.success&&(ce.value=a.data,V.value=a.data[0].id)}catch{}},He=async a=>{try{(await k.post("/Invoice/SearchInvoice",N.stringify({Id:a.id,invoicedepartmentid:V.value}))).success&&(b.msg("获取成功","success",!1),K())}catch{}},Je=()=>{U.value=0,T.value=0,P.value=0,w.value=[],K()},Qe=()=>{ve.value="导入列表",O.value=!0},We=a=>{r.value.size=a,z()},Xe=a=>{m.value=0,f.value=0,r.value.number=a,z()},Ke=a=>{m.value=0,f.value=0,d.value.size=a,F()},Ze=a=>{d.value.number=a,F()};function fe({row:a,column:e,rowIndex:v,columnIndex:y}){return{color:"#000",textAlign:"center"}}const me=o(""),j=o(!1),ea=a=>{Z.value=a.id,ee.value=a.serialNo,ae.value=a.buyerTaxNo,le.value=a.buyerName,te.value=a.invoiceTotalPrice,oe.value=a.invoiceTotalTax,me.value="修改",j.value=!0},aa=a=>a<34?"#409eff":a<60?"#e6a23c":"#67c23a";return J("deleteid",qe),J("getTableData",z),J("dialogShow",j),J("importshow",O),(a,e)=>{const v=u("el-button"),y=u("el-form-item"),q=u("el-option"),be=u("el-select"),ie=u("el-form"),I=u("el-table-column"),la=u("el-tag"),_e=u("el-table"),he=u("el-pagination"),we=u("el-input"),ta=u("el-date-picker"),G=u("el-dialog"),oa=u("el-progress"),ye=u("el-statistic"),xe=u("FullScreen"),Te=u("el-icon"),Ce=ua("loading");return p(),E("div",null,[s("div",va,[t(ie,{ref:"formbutton",inline:""},{default:n(()=>[t(y,null,{default:n(()=>[t(v,{icon:"DocumentCopy",type:"primary",disabled:c.value,onClick:Oe},{default:n(()=>[g("开票")]),_:1},8,["disabled"]),t(v,{icon:"Upload",type:"warning",disabled:c.value,onClick:Qe},{default:n(()=>[g("导入")]),_:1},8,["disabled"])]),_:1}),t(y,null,{default:n(()=>[t(v,{type:"primary",disabled:c.value,onClick:Le,icon:"Search"},{default:n(()=>[g("查询")]),_:1},8,["disabled"]),t(v,{type:"success",disabled:c.value,onClick:$e,icon:"Refresh"},{default:n(()=>[g("刷新")]),_:1},8,["disabled"])]),_:1}),t(y,{label:"开票单位",prop:"sobItems"},{default:n(()=>[t(be,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=l=>V.value=l),disabled:c.value,placeholder:"请选择开票单位",style:{width:"260px"}},{default:n(()=>[(p(!0),E(Q,null,re(ce.value,l=>(p(),C(q,{key:l.id,label:l.label,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1},512)]),s("div",pa,[Ne((p(),C(_e,{data:se.value,stripe:r.value.tableStripe,border:"","highlight-current-row":r.value.tableHighlightCurrentRow,"max-height":"300",style:{width:"100%",color:"#000"},"header-cell-style":fe,onSelectionChange:Ee,onCurrentChange:Be},{default:n(()=>[W("",!0),t(I,{type:"selection",width:"55",align:"center"}),(p(!0),E(Q,null,re(Pe.value,(l,H)=>(p(),C(I,{key:H,prop:l.prop,label:l.label,align:l.align,width:l.width},null,8,["prop","label","align","width"]))),128)),t(I,{prop:"istatus",label:"开票状态",align:"center",width:"160"},{default:n(l=>[t(la,{effect:"light",type:Ae(l.row.istatus)},{default:n(()=>[g(S(l.row.istatus),1)]),_:2},1032,["type"])]),_:1}),t(I,{prop:"msg",label:"开票失败提示",align:"center",width:"170"}),t(I,{label:"操作",align:"center",width:"250",fixed:"right"},{default:n(l=>[l.row.istatus=="已开票待返回电子版"?(p(),C(v,{key:0,type:"success",size:"small",onClick:H=>He(l.row)},{default:n(()=>[g("获取电子版")]),_:2},1032,["onClick"])):W("",!0),l.row.istatus=="待开票"?(p(),C(v,{key:1,type:"primary",size:"small",onClick:H=>ea(l.row)},{default:n(()=>[g("修改")]),_:2},1032,["onClick"])):W("",!0),t(v,{type:"danger",size:"small",onClick:H=>Ye(l.row.id)},{default:n(()=>[g("删除")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","stripe","highlight-current-row"])),[[Ce,D.value]])]),s("div",ga,[s("table",fa,[s("tr",null,[s("td",ma," 发票张数："+S(ne.value)+"张 ",1),s("td",ba," 价税合计："+S(f.value)+"元 ",1),s("td",_a," 合计税额："+S(m.value)+"元 ",1)])])]),s("div",ha,[t(he,{currentPage:r.value.number,"onUpdate:currentPage":e[1]||(e[1]=l=>r.value.number=l),"page-size":r.value.size,"onUpdate:pageSize":e[2]||(e[2]=l=>r.value.size=l),"page-sizes":r.value.sizes,background:r.value.background,layout:r.value.layout,total:r.value.total,disabled:c.value,onSizeChange:We,onCurrentChange:Xe},null,8,["currentPage","page-size","page-sizes","background","layout","total","disabled"])]),wa,s("div",ya,[Ne((p(),C(_e,{data:pe.value,stripe:r.value.tableStripe,border:"","highlight-current-row":r.value.tableHighlightCurrentRow,"max-height":"300",style:{width:"100%",color:"#000"},"header-cell-style":fe,"default-sort":de.value},{default:n(()=>[(p(!0),E(Q,null,re(Fe.value,l=>(p(),E(Q,null,[l.show?(p(),C(I,{key:0,prop:l.prop,label:l.label,align:l.align,width:l.width},null,8,["prop","label","align","width"])):W("",!0)],64))),256))]),_:1},8,["data","stripe","highlight-current-row","default-sort"])),[[Ce,h.value]])]),s("div",xa,[t(he,{currentPage:d.value.number,"onUpdate:currentPage":e[3]||(e[3]=l=>d.value.number=l),"page-size":d.value.size,"onUpdate:pageSize":e[4]||(e[4]=l=>d.value.size=l),"page-sizes":d.value.sizes,background:d.value.background,layout:d.value.layout,total:d.value.total,disabled:_.value,onSizeChange:Ke,onCurrentChange:Ze},null,8,["currentPage","page-size","page-sizes","background","layout","total","disabled"])]),t(G,{modelValue:M.value,"onUpdate:modelValue":e[9]||(e[9]=l=>M.value=l),title:"查询","align-center":"","destroy-on-close":"",width:"800px",draggable:"","close-on-click-modal":!1},{default:n(()=>[t(ie,{inline:!0,model:i.value,class:"inline","label-width":"100px"},{default:n(()=>[t(y,{label:"开票流水号"},{default:n(()=>[t(we,{modelValue:i.value.serino,"onUpdate:modelValue":e[5]||(e[5]=l=>i.value.serino=l)},null,8,["modelValue"])]),_:1}),t(y,{label:"客户名称"},{default:n(()=>[t(we,{modelValue:i.value.customername,"onUpdate:modelValue":e[6]||(e[6]=l=>i.value.customername=l)},null,8,["modelValue"])]),_:1}),t(y,{label:"开票日期"},{default:n(()=>[t(ta,{modelValue:i.value.invoiceDate,"onUpdate:modelValue":e[7]||(e[7]=l=>i.value.invoiceDate=l),type:"daterange","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1}),t(y,{label:"开票状态"},{default:n(()=>[t(be,{modelValue:i.value.status,"onUpdate:modelValue":e[8]||(e[8]=l=>i.value.status=l),clearable:""},{default:n(()=>[t(q,{label:"待开票",value:"待开票"}),t(q,{label:"已开票待返回电子版",value:"已开票待返回电子版"}),t(q,{label:"开票完成",value:"开票完成"})]),_:1},8,["modelValue"])]),_:1}),t(y,{style:{"margin-left":"30px"}},{default:n(()=>[t(v,{type:"primary",onClick:Me},{default:n(()=>[g("查询")]),_:1}),t(v,{type:"success",onClick:Re},{default:n(()=>[g("重置")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(G,{modelValue:Y.value,"onUpdate:modelValue":e[10]||(e[10]=l=>Y.value=l),top:"5vh",title:"完成进度","align-center":"",onClosed:Je,"destroy-on-close":"",width:"600px",draggable:"","close-on-click-modal":!1},{default:n(()=>[t(ie,{style:{width:"100%"}},{default:n(()=>[s("div",Ta,[s("div",Ca,[t(oa,{"text-inside":!0,"stroke-width":20,color:aa,percentage:U.value,striped:"","striped-flow":""},{default:n(()=>[ka,s("span",null,S(U.value)+"%",1)]),_:1},8,["percentage"])]),s("div",Na,[s("div",Va,[t(ye,{value:T.value},{title:n(()=>[za]),suffix:n(()=>[g("/"+S(w.value.length)+"张",1)]),_:1},8,["value"])]),s("div",Ia,[t(ye,{value:P.value},{title:n(()=>[Sa]),suffix:n(()=>[g("张")]),_:1},8,["value"])])])])]),_:1})]),_:1},8,["modelValue"]),t(G,{modelValue:j.value,"onUpdate:modelValue":e[18]||(e[18]=l=>j.value=l),title:me.value,onClose:e[19]||(e[19]=l=>B.value=!1),style:{position:"relative"},fullscreen:B.value,"align-center":"","destroy-on-close":"",width:"1300px",draggable:"","close-on-click-modal":!1},{default:n(()=>[t(Ve(Ie),{id:Z.value,"onUpdate:id":e[11]||(e[11]=l=>Z.value=l),serialNo:ee.value,"onUpdate:serialNo":e[12]||(e[12]=l=>ee.value=l),buyerTaxNo:ae.value,"onUpdate:buyerTaxNo":e[13]||(e[13]=l=>ae.value=l),buyerName:le.value,"onUpdate:buyerName":e[14]||(e[14]=l=>le.value=l),invoiceTotalPrice:te.value,"onUpdate:invoiceTotalPrice":e[15]||(e[15]=l=>te.value=l),invoiceTotalTax:oe.value,"onUpdate:invoiceTotalTax":e[16]||(e[16]=l=>oe.value=l)},null,8,["id","serialNo","buyerTaxNo","buyerName","invoiceTotalPrice","invoiceTotalTax"]),t(Te,{onClick:e[17]||(e[17]=l=>B.value=!B.value),style:{position:"absolute",right:"45px",top:"24px",cursor:"pointer","font-size":"14px"}},{default:n(()=>[t(xe)]),_:1})]),_:1},8,["modelValue","title","fullscreen"]),t(G,{modelValue:O.value,"onUpdate:modelValue":e[21]||(e[21]=l=>O.value=l),fullscreen:L.value,style:{position:"relative"},title:ve.value,"align-center":"","destroy-on-close":"",width:"1300px",onClose:e[22]||(e[22]=l=>L.value=!1),draggable:"","close-on-click-modal":!1},{default:n(()=>[t(Ve(Se)),t(Te,{onClick:e[20]||(e[20]=l=>L.value=!L.value),style:{position:"absolute",right:"45px",top:"24px",cursor:"pointer","font-size":"14px"}},{default:n(()=>[t(xe)]),_:1})]),_:1},8,["modelValue","fullscreen","title"])])}}});const Ya=na(Da,[["__scopeId","data-v-0d88d10b"]]);export{Ya as default};
