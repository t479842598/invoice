import{i as init}from"./_echarts-675f6544.js";import{ai as inject,aT as ref,aF as onMounted,c as createElementBlock,H as createBlock,aZ as resolveDynamicComponent,W as createVNode,bD as withCtx,aN as provide,aX as resolveComponent,o as openBlock}from"./_@vue-5ba92de9.js";import"./__vendor-5e6ac033.js";const _hoisted_1={class:"roadui_page"},_hoisted_2={key:0,style:{width:"100%",height:"inherit"}},_hoisted_3={key:1,id:"programDiv_chart",style:{width:"100%",height:"inherit"}},_hoisted_4={key:2,style:{width:"100%",height:"inherit",overflow:"auto"}},_sfc_main={__name:"index",props:{query:{type:String,default:()=>""}},setup(__props){const ajax=inject("ajax"),utils=inject("utils"),qs=inject("qs"),app=inject("app"),config=inject("config"),index_openmenu=inject("index_openmenu"),index_regcomponent=inject("index_regcomponent");inject("index_dialogshow");const ElSelectdict=inject("ElSelectdict"),ElSelectorg=inject("ElSelectorg"),props=__props;utils.query("programid",props.query);const programComponentId=ref(null),programComponentQuery=ref(""),programComponentRef=ref(null),dialogButtons=ref([]),isSelectDiv=utils.query("isselectdiv",props.query)=="1",selectdiv_dialogshow=isSelectDiv?inject("selectdiv_dialogshow"):null,selectdiv_ok=isSelectDiv?inject("selectdiv_ok"):null,selectdiv_selectvalues=isSelectDiv?inject("selectdiv_selectvalues"):null,propsQueryString=utils.getQuery(props.query),activeName=ref("list"),showType=ref(0),listLabel=ref("列表"),chartLabel=ref("图表"),programComponentId_Chart=ref(null),programComponentQuery_Chart=ref(""),programComponentRef_chart=ref(null),resData=ref({}),listData=ref([]);onMounted(()=>{load()});const tabClick=e=>{const t=e.props.name;t==="list"?utils.isUndef(programComponentId.value)&&regList(resData.value):t==="chart"&&utils.isUndef(programComponentId_Chart.value)&&regChart(resData.value)},load=()=>{ajax.post("/Program/GetRun?"+propsQueryString+"&iselement=1").then(e=>{if(resData.value=e,e.success)switch(showType.value=utils.hasKey(e.data,"chart")&&utils.hasKey(e.data.chart,"showType")&&e.data.chart.showType||0,showType.value===3&&(activeName.value="chart"),utils.hasKey(e.data,"chart")&&utils.length(e.data.chart.listLabel)>0&&(listLabel.value=e.data.chart.listLabel),utils.hasKey(e.data,"chart")&&utils.length(e.data.chart.chartLabel)>0&&(chartLabel.value=e.data.chart.chartLabel),showType.value){case 0:case 2:regList(e);break;case 1:case 3:regChart(e);break}}).catch(()=>{})},regList=res=>{const componentId="roadflow_program_"+utils.createGuid(!1),component={components:{"el-selectdict":ElSelectdict,"el-selectorg":ElSelectorg},data(){return{butDisabled:!1,loading:!1,id:res.data.id,applibraryId:res.data.applibraryId,selectOptions:res.data.selectOptions,buttonScripts:res.data.buttonScripts,buttonLangs:res.data.buttonLangs,buttonLangField:"name",selectRows:[],selectColumn:res.data.selectColumn,buttonShow:res.data.buttonShow,buttonShowScripts:res.data.buttonShowScripts,formData:res.data.formDataDefaultValue||{},tableData:[],summarySubSum:[],summarySum:[],pager:utils.getPager({}),defaultOrder:{},utils,sysConfig:config,indexOpenMenu:index_openmenu,propsQueryString,dialogFormUrl:res.data.modalFormUrl,dialogShow:!1,dialogWidth:utils.toNumber(res.data.modalWidth,900)+"px",dialogTitle:"",dialogPage:null,dialogQuery:"",dialogButtons:dialogButtons.value,dialogShowTitle:!1,dialogCloseOnPressEscape:!1,dialogCloseOnClickModal:!1,importDialogShow:!1,importDialogTitle:"导入",importDialogButtonTitle:"选择文件",importLoading:!1}},mounted(){this.$nextTick(()=>{this.loadData(!0),utils.length(res.data.clientScripts)>0&&eval(res.data.clientScripts)})},computed:{},methods:{loadData(e){e&&res.data.isPager&&(this.pager.number=1),this.butDisabled=!0,this.formData.size=res.data.isPager?this.pager.size:1e7,this.formData.number=this.pager.number,this.formData.order=this.pager.order,ajax.post("/Program/GetRunData?"+propsQueryString+"&iselement=1",qs.stringify(this.formData)).then(t=>{if(t.success)this.summarySubSum=t.data.subSum,this.summarySum=t.data.sum,this.tableData=t.data.rows,listData.value=t.data.rows,this.pager.total=t.data.total,this.initSelection(),e&&programComponentId_Chart.value&&showType.value>1&&regChart(resData.value);else{let a="";switch(t.code){case 1:a="未找到对应的应用！";break}utils.msg(a,!1)}this.butDisabled=!1}).catch(()=>{this.butDisabled=!1})},initSelection(){if(!isSelectDiv||utils.length(selectdiv_selectvalues.value)===0)return;const e=this.$refs["programTableRef_"+this.id];if(utils.isUndef(e))return;const t=selectdiv_selectvalues.value.split(",");for(let a=0;a<t.length;a++){const s=utils.getArrayObj(this.tableData,t[a],"id");utils.isUndef(s)||e.toggleRowSelection(s,!0)}},clearSelection(){const e=this.$refs["programTableRef_"+this.id];utils.isUndef(e)||e.clearSelection()},handleSelectionChange(e){this.selectRows=e},rowClick(e){isSelectDiv&&(this.selectRows=[],this.selectRows.push(e))},rowDblClick(e){isSelectDiv&&(this.selectRows=[],this.selectRows.push(e),this.confirmSelect())},sortChange(e){this.pager.order=utils.getOrder(e),this.loadData(!1)},handleSizeChange(e){this.pager.size=e,this.loadData(!1)},handleCurrentChange(e){this.pager.number=e,this.loadData(!1)},execButtonScript(id,row){const scripts=this.buttonScripts[id];if(utils.length(scripts)===0)return row;eval(scripts)},getButtonShow(id,row){const scripts=utils.hasKey(this.buttonShowScripts,id)?this.buttonShowScripts[id]:"";if(utils.length(scripts)===0)return!0;try{return eval(scripts)}catch(e){return!1}},edit(e,t,a){if(utils.length(this.dialogFormUrl)===0)return;const s=this.dialogFormUrl.split("?"),o=s[0],i="program_form_"+utils.createGuid(!1);var r=s.length>1?"?"+s[1]:"?a=1";utils.isDef(e)?(r+="&instanceid="+(e.id||"")+"&display="+(t||"0"),this.dialogTitle=""):this.dialogTitle="",index_regcomponent(i,o),this.dialogPage=i,this.dialogQuery=r+"&"+(a||""),this.dialogShow=!0},del(e){const t=utils.isDef(e)?[e.id]:utils.getArrayValues(this.selectRows,"id");if(t.length===0){utils.msg("您没有选择要删除的数据！",!1);return}utils.confirm("您确定要删除所选数据吗？",()=>{this.butDisabled=!0,ajax.post("/Program/DeleteData?programid="+this.id+"&applibraryid="+this.applibraryId,qs.stringify({ids:t.join(",")})).then(a=>{let s="";switch(a.code){case 0:s="删除成功！";break;case 1:s="应用未设置表单！";break;default:s="删除失败！";break}utils.msg(s,a.success),this.butDisabled=!1,a.success&&(this.loadData(!1),this.clearSelection(),this.selectRows=[])}).catch(()=>{})})},hiddenHeader(){this.dialogShowTitle||(this.$refs.programComponentDialogRef.$refs.dialogContentRef.$refs.headerRef.hidden=!0)},exportExcel(){const e=this.$refs.program_exportform;for(var t in this.formData){var a=document.getElementById(t);utils.isUndef(a)&&(a=document.createElement("input"),a.setAttribute("type","hidden"),a.setAttribute("name",t),a.setAttribute("id",t),e.appendChild(a)),a.value=this.formData[t]}var s=document.getElementById("exportSelectRows");utils.isUndef(s)&&(s=document.createElement("input"),s.setAttribute("type","hidden"),s.setAttribute("name","exportSelectRows"),s.setAttribute("id","exportSelectRows"),e.appendChild(s)),s.value=utils.getArrayValues(this.selectRows,"id").join(","),e.submit()},importExcel(){this.importDialogShow=!0},beforeAvatarUpload(e){return e.type!=="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"&&e.type!=="application/vnd.ms-excel"?(utils.msg("要导入的文件必须是excel格式文件!",!1),!1):(this.importLoading=!0,!0)},handleAvatarSuccess(e,t){if(t.status==="success"){if(e.code!=0){utils.msg("文件上传失败！",!1);return}const s=e.data.id;ajax.post("/Program/ImportExcel",qs.stringify({files:s,programId:this.id})).then(o=>{let i=o.msg;utils.length(i)===0&&(o.success?i="导入成功！":o.code==1?i="要导入的文件不存在！":o.code==2?i="未找到程序运行时！":o.code==3?i="未设置要导入的表！":o.code==4?i="未设置数据连接！":o.code==5?i="导入发生错误！请联系管理员！":i="导入失败！"),utils.msg(i,o.success),this.importDialogShow=!1,this.importLoading=!1,o.success&&this.loadData()}).catch(()=>{})}else t.status==="error"&&utils.msg("文件上传失败！",!1)},closeDialog(){utils.isDef(selectdiv_dialogshow.value)&&(selectdiv_dialogshow.value=!1)},confirmSelect(){utils.isFunction(selectdiv_ok)&&selectdiv_ok(this.selectRows)},rowSelectableFun(e,t){return utils.isFunction(this.rowSelectable)?this.rowSelectable(e,t):!0},summaryMethod1(e){for(var t=[],a=!1,s=0;s<e.columns.length;s++)if(utils.length(this.summarySubSum)>0||utils.length(this.summarySum)>0){const l=e.columns[s].property;var o=[],i=[];if(utils.length(this.summarySubSum)>0){var r=utils.hasKey(this.summarySubSum,l)?this.summarySubSum[l]:"";utils.length(r)>0&&o.push(r),i.push("小计")}if(utils.length(this.summarySum)>0){var n=utils.hasKey(this.summarySum,l)?this.summarySum[l]:"";utils.length(n)>0&&o.push(n),i.push("合计")}!a&&e.columns[s].type==="default"&&o.length===0?(t.push(i.join("/")),a=!0):t.push(o.join("/"))}else t.push("");return t},indexMethod(e){const t=utils.toNumber(this.formData.size,10),a=utils.toNumber(this.formData.number,1);return e+(t*a-t)+1},downloadFiles(e,t){const a=utils.isDef(e)?[e]:this.selectRows;if(a.length===0){utils.msg("您没有选择要下载的行！",!1);return}const s=[];for(let i=0;i<a.length;i++){var o=a[i][t];if(utils.isArray(o))for(let r=0;r<o.length;r++)s.push(o[r].id);else s.push(o)}if(s.length===0){utils.msg("没有要下载的文件！",!1);return}this.butDisabled=!0,ajax.post("/Program/DownloadFiles?programid="+this.id+"&applibraryid="+this.applibraryId,qs.stringify({ids:JSON.stringify(s)})).then(i=>{if(this.butDisabled=!1,i.success){this.clearSelection(),this.selectRows=[];const r=this.sysConfig.SERVER_WEBADDRESS+"/Files/Show?id="+i.msg+"&contenttype=attachment&nroadflow-token="+utils.getToken();utils.open(r,300,200,"",!1)}else{let r="";i.code===1&&(r="没有要下载的文件！"),utils.msg(r,!1)}}).catch(()=>{})}},template:"<div>"+res.data.template+"</div>"};app.component(componentId,component),programComponentId.value=componentId},regChart=res=>{const componentId_chart="roadflow_program_chart_"+utils.createGuid(!1),component_chart={data(){return{width:800,height:500,chartOption:{},pager:utils.getPager({}),formData:res.data.formDataDefaultValue||{},rows:listData.value}},mounted(){var e=document.getElementById("programDiv_chart");this.width=e.clientWidth,this.height=e.clientHeight,this.$nextTick(()=>{setTimeout(()=>{this.showChart()},500)})},methods:{showChart(){showType.value===1||showType.value===3&&this.rows.length===0?this.loadData(!0):this.loadChart()},loadChart(){var programChart=init(document.getElementById("programChartRef"),res.data.chart.dark===1?"dark":"",{height:document.getElementById("app").clientHeight-150,width:this.width});this.chartOption=res.data.chart.option,utils.length(res.data.clientScripts)>0&&eval(res.data.clientScripts),programChart.setOption(this.chartOption)},loadData(e){e&&res.data.isPager&&(this.pager.number=1),this.butDisabled=!0,this.formData.size=res.data.isPager?this.pager.size:1e7,this.formData.number=this.pager.number,this.formData.order=this.pager.order,ajax.post("/Program/GetRunData?"+propsQueryString+"&iselement=1",qs.stringify(this.formData)).then(t=>{if(t.success)listData.value=t.data.rows,this.rows=t.data.rows,this.loadChart();else{let a="";switch(t.code){case 1:a="未找到对应的应用！";break}utils.msg(a,!1)}this.butDisabled=!1}).catch(()=>{this.butDisabled=!1})}},template:`<div id="programChartRef" ref="programChartRef" :style="'width:'+width+'px;height:`+(document.getElementById("app").clientHeight-150)+`px'"></div>`};app.component(componentId_chart,component_chart),programComponentId_Chart.value=componentId_chart};return provide("programrun_programcomponentref",programComponentRef),(e,t)=>{const a=resolveComponent("el-tab-pane"),s=resolveComponent("el-tabs");return openBlock(),createElementBlock("div",_hoisted_1,[showType.value===0?(openBlock(),createElementBlock("div",_hoisted_2,[(openBlock(),createBlock(resolveDynamicComponent(programComponentId.value),{ref_key:"programComponentRef",ref:programComponentRef,query:programComponentQuery.value},null,8,["query"]))])):showType.value===1?(openBlock(),createElementBlock("div",_hoisted_3,[(openBlock(),createBlock(resolveDynamicComponent(programComponentId_Chart.value),{ref_key:"programComponentRef_chart",ref:programComponentRef_chart,query:programComponentQuery_Chart.value},null,8,["query"]))])):(openBlock(),createElementBlock("div",_hoisted_4,[createVNode(s,{modelValue:activeName.value,"onUpdate:modelValue":t[0]||(t[0]=o=>activeName.value=o),onTabClick:tabClick,style:{width:"100%"},id:"programDiv_chart"},{default:withCtx(()=>[createVNode(a,{label:listLabel.value,name:"list"},{default:withCtx(()=>[(openBlock(),createBlock(resolveDynamicComponent(programComponentId.value),{ref_key:"programComponentRef",ref:programComponentRef,query:programComponentQuery.value},null,8,["query"]))]),_:1},8,["label"]),createVNode(a,{label:chartLabel.value,name:"chart"},{default:withCtx(()=>[(openBlock(),createBlock(resolveDynamicComponent(programComponentId_Chart.value),{ref_key:"programComponentRef_chart",ref:programComponentRef_chart,query:programComponentQuery_Chart.value},null,8,["query"]))]),_:1},8,["label"])]),_:1},8,["modelValue"])]))])}}};export{_sfc_main as default};
