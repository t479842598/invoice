import{R as x}from"./_raphael-a934d412.js";var p=[],s;const b={wf_r:null,wf_steps:[],wf_texts:[],wf_conns:[],wf_imgs:[],wf_option:"",wf_focusObj:null,wf_width:108,wf_height:50,wf_rect:10,wf_designer:!0,wf_connColor:"#11a983",wf_nodeBorderColor:"#11a983",wf_noteColor:"#11a983",wf_nodeTextColor:"#ffffff",wf_nodeTextSize:14,wf_hoverColor:"#ed0404",wf_focusColor:"#E6A23C",wf_stepDefaultName:"步骤",wf_lineType:0,mouseX:0,mouseY:0,wf_json:{},wf_id:"",pager_id:"",dialogVisible:null,dialogRef:null,dialogData:[],roaduiUtils:{},init(t,r,e,i,f){this.wf_id=t,this.pager_id="flowShowDiv_"+t,this.wf_designer=f,s=this,i&&(this.wf_connColor=i.line,this.wf_nodeBorderColor=i.step,this.wf_noteColor=i.step,this.wf_focusColor=i.focus,this.wf_nodeTextSize=i.fontSize),this.wf_r=x(this.pager_id,r,e),this.wf_r.customAttributes.type1=function(){},this.wf_r.customAttributes.fromid=function(){},this.wf_r.customAttributes.toid=function(){},x.fn.drawArr=function(h,a){if(!(!h||!h.obj1)){if(a=a||s.wf_lineType||0,!h.obj2){for(var o=s.getStartEnd(h.obj1,h.obj2),n=s.getArr(o.start.x,o.start.y,s.mouseX,s.mouseY,0,a),g=0;g<p.length;g++)p[g].arrPath.remove();return p=[],h.arrPath=this.path(n),h.arrPath.attr({"stroke-width":2,"stroke-dasharray":"-","arrow-end":"block-wide-long",stroke:s.wf_connColor}),p.push(h),null}var l=s.getStartEnd(h.obj1,h.obj2),w=s.getArr(l.start.x,l.start.y,l.end.x,l.end.y,8,a);h.arrPath?h.arrPath.attr({path:w}):(h.arrPath=this.path(w),h.arrPath.attr({"stroke-width":2,stroke:s.wf_connColor,fill:s.wf_connColor}),s.wf_designer&&(h.arrPath.id=h.id,h.arrPath.fromid=h.obj1.id,h.arrPath.toid=h.obj2.id,h.arrPath.click(s.connClick),h.arrPath.dblclick(s.connSet))),s.wf_lineType=void 0;for(var u=0;u<p.length;u++)p[u].arrPath.remove();return p=[],h}},Array.prototype.remove=function(h){for(var a=0;a<this.length;a++){var o=this[a];if(isNaN(h)||(o=a),o==h){for(var n=a;n<this.length;n++)this[n]=this[n+1];this.length=this.length-1}}}},mouseMove(t){t=t||window.event;var r=s.mouseCoords(t);s.mouseX=r.x,s.mouseY=r.y;var e={obj1:s.wf_focusObj,obj2:null};s.wf_r.drawArr(e)},mouseCoords(t){return t.offsetX||t.offsetY?{x:t.offsetX-5,y:t.offsetY-5}:{x:t.offsetX+document.body.scrollLeft-document.body.clientLeft,y:t.offsetY+document.body.scrollTop-document.body.clientTop}},getGuid(){return x.createUUID()},addStep(t,r,e,i,f,h,a,o,n,g,l){var w=this.getGuid(),u=this.getNewXY();t=t||u.x,r=r||u.y,e=e||this.wf_stepDefaultName,i=i||w;var _=this.wf_r.rect(t,r,this.wf_width,this.wf_height,n||this.wf_rect),v=o||this.wf_noteColor;_.attr({fill:v,stroke:a||this.wf_nodeBorderColor,"stroke-width":0,title:e,cursor:"default"}),_.id=i,_.type1=h||"normal",_.data("stepcolor",v),l&&l.length>0&&(_.attr({cursor:"pointer"}),_.mouseover(function(){s.dialogVisible.value=!0,s.dialogRef.value.style.top=r+180+"px",s.dialogRef.value.style.left=t+20+"px",s.dialogData.value=l}),_.mouseout(function(){s.dialogVisible.value=!1})),this.wf_steps.push(_);var y=g&&g.toString().trim().length>0,S=this.getNtext(e),c=this.wf_r.text(t+52,r+(y?32:25),S);if(c.attr({"font-size":this.wf_nodeTextSize.toString()+"px","font-family":"sans-serif",fill:this.wf_nodeTextColor}),c.id="text_"+i,c.type1="text",l&&l.length>0&&(c.attr({cursor:"pointer"}),c.mouseover(function(){s.dialogVisible.value=!0,s.dialogRef.value.style.top=r+180+"px",s.dialogRef.value.style.left=t+20+"px",s.dialogData.value=l}),c.mouseout(function(){s.dialogVisible.value=!1})),this.wf_texts.push(c),y){var m=this.wf_r.image(g,t+42,r+7,16,16);m.id="img_"+i,m.type1="image",this.wf_imgs.push(m)}if((f==null||f==null)&&(f=!0),f){var d={};d.id=i,d.type=h||"normal",d.name=e,d.position={x:t,y:r,width:this.wf_width,height:this.wf_height},d.opinionDisplay="",d.expiredPrompt="",d.signatureType="",d.workTime="",d.limitTime="",d.otherTime="",d.archives="",d.archivesParams="",d.note="",d.behavior={},d.forms=[],d.buttons=[],d.fieldStatus=[],d.event={},d.subflow={},this.addStep1(d)}},getNtext(t){return t=(t||"").toString().trim(),t.replace(/\\n/g,`
`)},addSubFlow(){this.addStep(null,null,"子流程步骤",null,null,"subflow",null,null)},clone(t){var r;switch(typeof t){case"undefined":break;case"string":r=t+"";break;case"number":r=t-0;break;case"boolean":r=t;break;case"object":if(t===null)r=null;else if(t instanceof Array){r=[];for(var e=0,i=t.length;e<i;e++)r.push(this.clone(t[e]))}else{r={};for(var f in t)r[f]=this.clone(t[f])}break;default:r=t;break}return r},setStepStyle(t,r,e){var i=this.wf_r.getById(t);if(i){var f="";if(r?f=r:f=this.wf_noteColor,i.attr("fill",f),i.data("stepcolor",f),e){if(e=="0")i.attr("r",this.wf_rect);else if(e=="1")i.attr({r:this.wf_height});else if(e=="2"){i.attr({width:this.wf_height+25,height:this.wf_height+25,r:this.wf_height+25});var h=this.wf_r.getById("text_"+t);if(h){var a=h.attr("x");h.attr({x:parseFloat(a)+15-(this.wf_height+50)/2})}}}}},getNewXY(){var t=10,r=50;if(this.wf_steps.length>0){var e=this.wf_steps[this.wf_steps.length-1];t=parseInt(e.attr("x"))+170,r=parseInt(e.attr("y")),t>this.wf_r.width-this.wf_width&&(t=10,r=r+100),r>this.wf_r.height-this.wf_height&&(r=this.wf_r.height-this.wf_height)}return{x:t,y:r}},addConn(t){if(!this.wf_focusObj||!this.isStepObj(this.wf_focusObj))return alert("请选择要连接的步骤！"),!1;this.wf_option="line",this.wf_lineType=t,document.body.onmousemove=this.mouseMove,document.body.onmousedown=function(){for(var r=0;r<p.length;r++)p[r].arrPath.remove();p=[],document.body.onmousemove=null}},connObj(t,r,e,i){if((r==null||r==null)&&(r=!0),this.isLine(t)){i=i==null||i==null?this.wf_lineType:i;var f=this.wf_r.drawArr(t,i);if(this.wf_conns.push(f),r){var h={};h.id=t.id,h.from=t.obj1.id,h.to=t.obj2.id,h.customMethod="",h.sql="",h.noaccordMsg="",h.text=e||"",h.lineType=i||this.wf_lineType||0,this.addLine(h)}else e&&this.setLineText(t.id,e)}},click(){switch(s.wf_option){case"line":var t={id:s.getGuid(),obj1:s.wf_focusObj,obj2:this};s.connObj(t);break;default:s.changeStyle(this);break}s.wf_option="",s.wf_lineType=void 0,s.wf_focusObj=this},connClick(){for(var t=0;t<s.wf_conns.length;t++)s.wf_conns[t].arrPath===this?s.wf_conns[t].arrPath.attr({stroke:s.wf_focusColor,fill:s.wf_focusColor}):s.wf_conns[t].arrPath.attr({stroke:s.wf_connColor,fill:s.wf_connColor});s.wf_focusObj=this},isLine(t){if(!t||!t.obj1||!t.obj2||t.obj1===t.obj2||!this.isStepObj(t.obj1)||!this.isStepObj(t.obj2))return!1;for(var r=0;r<this.wf_conns.length;r++)if(t.obj1===t.obj2||this.wf_conns[r].obj1===t.obj1&&this.wf_conns[r].obj2===t.obj2)return!1;return!0},isStepObj(t){return t&&t.type1&&(t.type1.toString()=="normal"||t.type1.toString()=="subflow")},setLineText(t,r){for(var e,i=0;i<this.wf_conns.length;i++)if(this.wf_conns[i].id==t){e=this.wf_conns[i];break}if(e){var f=e.arrPath.getBBox(),h=(f.x+f.x2)/2,a=(f.y+f.y2)/2,o=this.wf_r.getById("line_"+t);if(o!=null){r?(o.attr("x",h),o.attr("y",a),o.attr("text",r||""),o.attr({"font-size":"14px"})):o.remove();return}if(r){var n=this.wf_r.text(h,a,r);n.type1="line",n.id="line_"+t,n.attr({"font-size":"14px"}),this.wf_texts.push(n)}}},changeStyle(t){if(!(!t||!this.wf_designer))for(var r=0;r<this.wf_steps.length;r++){var e=this.wf_noteColor;this.wf_steps[r].data("stepcolor")&&(e=this.wf_steps[r].data("stepcolor")),this.wf_steps[r].id==t.id?(this.wf_steps[r].attr("fill",this.wf_focusColor),this.wf_steps[r].attr("stroke",this.wf_focusColor)):(this.wf_steps[r].attr("fill",e),this.wf_steps[r].attr("stroke",this.wf_nodeBorderColor))}},dragger(){this.ox=this.attr("x"),this.oy=this.attr("y"),s.changeStyle(this)},move(t,r){var e=this.ox+t,i=this.oy+r;if(e<10?e=10:e>s.wf_r.width-s.wf_width&&(e=s.wf_r.width-s.wf_width),i<10?i=10:i>s.wf_r.height-s.wf_height&&(i=s.wf_r.height-s.wf_height),this.attr("x",e),this.attr("y",i),this.id){var f=s.wf_r.getById("img_"+this.id);f!=null&&(f.attr("x",e+42),f.attr("y",i+7));var h=s.wf_r.getById("text_"+this.id);h!=null&&(h.attr("x",e+52),h.attr("y",i+(f?32:25)))}for(var a=s.wf_conns.length;a--;)if(s.wf_conns[a].obj1.id==this.id||s.wf_conns[a].obj2.id==this.id){for(var o=0,n=0;n<s.wf_json.lines.length;n++)if(s.wf_json.lines[n].id==s.wf_conns[a].arrPath.id){s.setLineText(s.wf_json.lines[n].id,s.wf_json.lines[n].text),o=s.wf_json.lines[n].lineType;break}s.wf_r.drawArr(s.wf_conns[a],o)}},up(){if(s.changeStyle(this),s.isStepObj(this)){var t=this.getBBox();if(t){var r=s.wf_json.steps;if(r&&r.length>0){for(var e=0;e<r.length;e++)if(r[e].id==this.id){r[e].position={x:t.x,y:t.y,width:t.width,height:t.height};break}}}}},getStartEnd(t,r){for(var e=t?t.getBBox():null,i=r?r.getBBox():null,f=[{x:e.x+e.width/2,y:e.y-1},{x:e.x+e.width/2,y:e.y+e.height+1},{x:e.x-1,y:e.y+e.height/2},{x:e.x+e.width+1,y:e.y+e.height/2},i?{x:i.x+i.width/2,y:i.y-1}:{},i?{x:i.x+i.width/2,y:i.y+i.height+1}:{},i?{x:i.x-1,y:i.y+i.height/2}:{},i?{x:i.x+i.width+1,y:i.y+i.height/2}:{}],h={},a=[],o=0;o<4;o++)for(var n=4;n<8;n++){var g=Math.abs(f[o].x-f[n].x),l=Math.abs(f[o].y-f[n].y);(o==n-4||(o!=3&&n!=6||f[o].x<f[n].x)&&(o!=2&&n!=7||f[o].x>f[n].x)&&(o!=0&&n!=5||f[o].y>f[n].y)&&(o!=1&&n!=4||f[o].y<f[n].y))&&(a.push(g+l),h[a[a.length-1]]=[o,n])}if(a.length==0)var w=[0,4];else w=h[Math.min.apply(Math,a)];var u={};return u.start={},u.end={},u.start.x=f[w[0]].x,u.start.y=f[w[0]].y,u.end.x=f[w[1]].x,u.end.y=f[w[1]].y,u},getStartEnd1(t,r){for(var e=t.getBBox(),i=r.getBBox(),f=[{x:e.x+e.width/2,y:e.y-1},{x:e.x+e.width/2,y:e.y+e.height+1},{x:e.x-1,y:e.y+e.height/2},{x:e.x+e.width+1,y:e.y+e.height/2},{x:i.x+i.width/2,y:i.y-1},{x:i.x+i.width/2,y:i.y+i.height+1},{x:i.x-1,y:i.y+i.height/2},{x:i.x+i.width+1,y:i.y+i.height/2}],h={},a=[],o=0;o<4;o++)for(var n=4;n<8;n++){var g=Math.abs(f[o].x-f[n].x),l=Math.abs(f[o].y-f[n].y);(o==n-4||(o!=3&&n!=6||f[o].x<f[n].x)&&(o!=2&&n!=7||f[o].x>f[n].x)&&(o!=0&&n!=5||f[o].y>f[n].y)&&(o!=1&&n!=4||f[o].y<f[n].y))&&(a.push(g+l),h[a[a.length-1]]=[o,n])}if(a.length==0)var w=[0,4];else w=h[Math.min.apply(Math,a)];var u=f[w[0]].x,_=f[w[0]].y,v=f[w[1]].x,y=f[w[1]].y;g=Math.max(Math.abs(u-v)/2,10),l=Math.max(Math.abs(_-y)/2,10);var S=[u,u,u-g,u+g][w[0]].toFixed(3),c=[_-l,_+l,_,_][w[0]].toFixed(3),m=[0,0,0,0,v,v,v-g,v+g][w[1]].toFixed(3),d=[0,0,0,0,_+l,_-l,y,y][w[1]].toFixed(3),C=["M",u.toFixed(3),_.toFixed(3),"C",S,c,m,d,v.toFixed(3),y.toFixed(3)].join(",");return C},getArr(t,r,e,i,f,h){if(h||(h=0),h==0){var a=x.angle(t,r,e,i),o=x.rad(a-28),n=x.rad(a+28),g=e+Math.cos(o)*f,l=i+Math.sin(o)*f,w=e+Math.cos(n)*f,u=i+Math.sin(n)*f;return["M",t,r,"L",e,i,"M",e,i,"L",w,u,"L",g,l,"Z"].join(",")}else if(h==1){var _=t,v=i>r?270:90;t<e?(_=(e-t)/2+t,v=180):t>e&&(_=(t-e)/2+e,v=0);var y=x.rad(v-28),S=x.rad(v+28),c=e+Math.cos(y)*f,m=i+Math.sin(y)*f,d=e+Math.cos(S)*f,C=i+Math.sin(S)*f;return["M",t,r,"L",_,r,"M",_,r,"L",_,i,"M",_,i,"L",e,i,"M",e,i,"L",d,C,"L",c,m,"Z"].join(",")}return""},initwf(){this.wf_json={},this.wf_steps=new Array,this.wf_texts=new Array,this.wf_conns=new Array,this.wf_r.clear()},removeArray(t,r){if(isNaN(r)||r>t.length)return!1;t.splice(r,1)},addStep1(t){if(t){this.wf_json.steps||(this.wf_json.steps=[]);for(var r=!1,e=0;e<this.wf_json.steps.length;e++)this.wf_json.steps[e].id==t.id&&(this.wf_json.steps[e]=t,this.setStepStyle(t.id,t.stepColor,t.stepShape),r=!0);r||this.wf_json.steps.push(t)}},addLine(t){if(!(!t||!t.from||!t.to)){this.wf_json.lines||(this.wf_json.lines=[]);for(var r=!1,e=0;e<this.wf_json.lines.length;e++)this.wf_json.lines[e].id==t.id&&(t.lineType=this.wf_json.lines[e].lineType,this.wf_json.lines[e]=t,r=!0);r||this.wf_json.lines.push(t),this.setLineText(t.id,t.text)}},getStepStatus(t,r){if(!t||!r||r.length===0)return{completed:!1,ing:!1,noin:!0};for(var e=[],i=0;i<r.length;i++)r[i].taskType==5||r[i].taskType==11||r[i].stepId==t&&e.push(r[i]);for(var f=e.length>0,h=0;h<e.length;h++)if(e[h].status==0){f=!1;break}return{completed:f,noin:e.length===0}},reloadFlow(t,r){if(!t||!t.id||t.id.toString().trim()=="")return!1;this.wf_json=t,this.wf_id=this.wf_json.id,this.wf_r.clear(),this.wf_steps=[],this.wf_conns=[],this.wf_texts=[];var e=this.wf_json.steps;if(e&&e.length>0)for(var i=0;i<e.length;i++){var f=r==null?this.wf_noteColor:"#909399";if(r&&r.length>0){var h=this.getStepStatus(e[i].id,r);h.completed?f="#67C23A":h.noin?f="#909399":f=this.wf_focusColor}this.wf_nodeBorderColor=f,this.wf_noteColor=f;var a=[];if(r)for(var o=0;o<r.length;o++)r[o].stepId==e[i].id&&a.push(r[o]);this.addStep(e[i].position.x,e[i].position.y,e[i].name,e[i].id,!1,e[i].type,"","",e[i].stepShape==1?this.wf_height:this.wf_rect,e[i].ico,a)}var n=this.wf_json.lines;if(n&&n.length>0)for(var o=0;o<n.length;o++){var g=r==null?this.wf_connColor:"#909399";if(r&&r.length>0){var l=this.getStepStatus(n[o].from,r),w=this.getStepStatus(n[o].to,r);!l.noin&&!w.noin?g="#67C23A":g="#909399"}this.wf_connColor=g,this.connObj({id:n[o].id,obj1:this.wf_r.getById(n[o].from),obj2:this.wf_r.getById(n[o].to)},!1,n[o].text,n[o].lineType)}},deleteStep(t){var r=this.wf_json.steps;if(r&&r.length>0)for(var e=0;e<r.length;e++)r[e].id==t&&this.removeArray(r,e)},deleteLine(t,r){var e=this.wf_json.lines;if(e&&e.length>0)for(var i=0;i<e.length;i++)e[i].id==t&&this.removeArray(e,i);if(r&&this.wf_texts&&this.wf_texts.length>0)for(var f=0;f<this.wf_texts.length;f++)this.wf_texts[f].id=="line_"+r&&this.wf_texts[f].remove()},replace(t,r,e){return t&&t.replace(new RegExp(r,"gm"),e)},openFlow(t,r){this.reloadFlow(t,r)}};export{b as f};
