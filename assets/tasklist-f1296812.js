import{a as be,_ as ta}from"./index-823f4b27.js";import{d as oa,aT as t,ai as w,aF as na,by as sa,b5 as ia,c as Q,a as s,W as o,bD as n,bF as _e,H as C,b9 as N,aX as d,aY as ra,aP as ua,aM as da,aN as te,o as g,U as p,I as R,F as oe,aV as he,bi as ye,Y as we}from"./_@vue-5ba92de9.js";import"./__vendor-5e6ac033.js";import"./_@element-plus-ad4c9002.js";import"./_crypto-js-0812dcff.js";import"./_element-plus-8c7ce171.js";import"./_@popperjs-c75af06c.js";import"./_pdfjs-dist-c04561eb.js";import"./_@microsoft-43c4e133.js";import"./_vue-codemirror-50da885a.js";const W=O=>(ua("data-v-d1b39fb3"),O=O(),da(),O),ca={class:"form-container"},va={class:"table-container"},pa={class:"table-text"},ga={border:"0",class:"table",style:{position:"relative"},width:"900"},ma={width:"300",align:"center"},fa={width:"300",align:"center"},ba={width:"300",align:"left"},_a={class:"roadui_pagerdiv"},ha=W(()=>s("div",null,[s("h3",{class:"before"},"发票明细")],-1)),ya={class:"table-container"},wa={class:"roadui_pagerdiv"},xa={style:{margin:"auto",width:"80%"}},Na={style:{"margin-top":"10px"}},Ta=W(()=>s("span",null,"正在开票中",-1)),ka={style:{"margin-top":"10px",margin:"10px auto",display:"flex","justify-content":"space-around"}},Ca={class:"successfa"},za=W(()=>s("div",{style:{display:"inline-flex","align-items":"center","font-size":"14px"}}," 已开票 ",-1)),Da={class:"errorfa"},Sa=W(()=>s("div",{style:{display:"inline-flex","align-items":"center","font-size":"14px"}}," 开票失败 ",-1)),Va=oa({__name:"tasklist",props:{query:{type:String,default:()=>""}},setup(O){const xe=we(()=>be(()=>import("./taskEdit-249c23b5.js"),["./taskEdit-249c23b5.js","./_@vue-5ba92de9.js","./__vendor-5e6ac033.js","./__vendor-693c365c.css","./index-823f4b27.js","./_@element-plus-ad4c9002.js","./_crypto-js-0812dcff.js","./_element-plus-8c7ce171.js","./_@popperjs-c75af06c.js","./_element-plus-7d03f811.css","./_pdfjs-dist-c04561eb.js","./_@microsoft-43c4e133.js","./_vue-codemirror-50da885a.js","./index-2ccff9e2.css","./taskEdit-c1526f24.css"],import.meta.url)),Ne=we(()=>be(()=>import("./HandEditNew-3023c3f1.js"),["./HandEditNew-3023c3f1.js","./_@vue-5ba92de9.js","./__vendor-5e6ac033.js","./__vendor-693c365c.css","./_element-plus-8c7ce171.js","./_@element-plus-ad4c9002.js","./_@popperjs-c75af06c.js","./_element-plus-7d03f811.css","./index-823f4b27.js","./_crypto-js-0812dcff.js","./_pdfjs-dist-c04561eb.js","./_@microsoft-43c4e133.js","./_vue-codemirror-50da885a.js","./index-2ccff9e2.css","./HandEditNew-dc4c7a8c.css"],import.meta.url)),Y=t(!1),H=t(!1),S=w("ajax"),x=w("utils");w("config");const V=w("qs");w("index_openmenu"),w("index_removetab");const ne=w("index_refreshtab");w("submit_dialogshow");const T=t("");localStorage.getItem("sobInfo")!=""&&(T.value=JSON.parse(localStorage.getItem("sobInfo")));const se=t({prop:"serialNo",order:"ascending"}),Te=t({prop:"goodsLineNo",order:"ascending"}),r=t(x.getPager(se.value)),u=t(x.getPager(Te.value)),b=t(!1),_=t(!1),I=t(!1),h=t(!1),j=t(!1);t("全部");const $=t(""),U=t(""),P=t(""),F=t(""),E=t(""),ke=t(""),Ce=t(""),ze=t(""),ie=t(),De=t([]),A=t(""),Se=w("index_userinfo"),B=t({Id:"",invoicedepartname:"",taxno:""}),q=t(!1),X=t(0),m=t(0),f=t(0);na(async()=>{await z(),await He()});const y=t([]),k=t(0),L=t(0),M=t(0),Ve=t([{prop:"serialNo",label:"开票流水号",align:"center",width:"200"},{prop:"billcode",label:"单据号",align:"center",width:"200"},{prop:"buyerName",label:"客户名称",align:"center",width:"250"},{prop:"buyerTaxNo",label:"税号",align:"center",width:"200"},{prop:"invoiceTotalPriceTax",label:"价税合计",align:"right",width:"100"},{prop:"invoiceTotalTax",label:"税额",align:"center",width:"110"},{prop:"invoiceTypeName",label:"发票类型",align:"center",width:"130"},{prop:"invoiceDate",label:"开票日期",align:"center",width:"180"},{prop:"invoiceNo",label:"发票号",align:"center",width:"220"},{prop:"remarks",label:"备注",align:"center",width:"220"}]),Ie=t([{prop:"id",align:"center",show:!1},{prop:"goodsLineNo",label:"序号",align:"center",show:!0,width:"60"},{prop:"goodsCode",label:"商品编号",show:!0,align:"center",width:"200"},{prop:"goodsName",label:"商品名称",show:!0,align:"center",width:"160"},{prop:"goodsSpecification",label:"规格型号",show:!0,align:"center",width:"180"},{prop:"goodsUnit",label:"单位",show:!0,align:"center",width:"100"},{prop:"goodsQuantity",label:"数量",show:!0,align:"center",width:"120"},{prop:"goodsPrice",label:"单价",show:!0,align:"center",width:"120"},{prop:"goodsTotalPrice",label:"价税合计",show:!0,align:"right",width:"120"},{prop:"notaxamount",label:"无税金额",show:!0,align:"right",width:"120"},{prop:"goodsTaxRate",label:"税率/征收率",show:!0,align:"center",width:"150"},{prop:"goodsTotalTax",label:"税额",show:!0,align:"center"}]),Ue=e=>{y.value=Array.from(new Set(e.map(a=>a.id)))},K=t([]),Z=t([]),i=t({serino:"",customername:"",invoiceDate:"",status:""});async function z(){try{I.value=!0,h.value=!0,b.value=!0,_.value=!0,i.value.size=r.value.size,i.value.number=r.value.number,i.value.order=r.value.order,i.value.invoicedepartmentid=ie.value,i.value.date1=i.value.invoiceDate[0],i.value.date2=i.value.invoiceDate[1],i.value.type="未开票";const e=await S.post("/Invoice/GetList?srcorgid="+T.value.id,V.stringify(i.value));if(e.data.rows.length>0){I.value=!1,h.value=!1,b.value=!1,_.value=!1,K.value=e.data.rows,X.value=e.data.total,$.value=e.data.rows[0].id,r.value.total=e.data.total,m.value=0,f.value=0;for(let a=0;a<e.data.rows.length;a++)m.value=Number((m.value+Number(e.data.rows[a].invoiceTotalPriceTax)).toFixed(2)),f.value=Number((f.value+Number(e.data.rows[a].invoiceTotalTax)).toFixed(2));G()}else{I.value=!1,h.value=!1,b.value=!0,_.value=!0,K.value=e.data.rows,X.value=e.data.total,$.value="0",r.value.total=e.data.total,u.value.total=e.data.total,Z.value=[];for(let a=0;a<e.data.rows.length;a++)m.value=Number((m.value+Number(e.data.rows[a].invoiceTotalPriceTax)).toFixed(2)),f.value=Number((f.value+Number(e.data.rows[a].invoiceTotalTax)).toFixed(2))}}catch{b.value=!1,_.value=!1,I.value=!1,h.value=!1}finally{}}const re=t({}),G=async()=>{h.value=!0,b.value=!0,_.value=!0,re.value={id:$.value,size:u.value.size,number:u.value.number,order:u.value.order};try{const e=await S.post("/Invoice/GetInvoiceDetailMain",V.stringify(re.value));e.data.rows.length>0&&(h.value=!1,b.value=!1,_.value=!1,Z.value=e.data.rows),u.value.total=e.data.total}catch{h.value=!1,b.value=!1,_.value=!1}finally{h.value=!1,b.value=!1,_.value=!1}},Pe=e=>{switch(e){case"开票完成":return"success";case"待开票":return"danger";case"已开票待返回电子版":return"warning";default:return"info"}},Fe=(e,a)=>{e!=null&&($.value=e.id,u.value.number=1,G())},Ee=()=>{j.value=!0},Ae=()=>{f.value=0,m.value=0,r.value.number=1,z(),j.value=!1},Be=()=>{f.value=0,m.value=0,i.value={serino:"",customername:"",invoiceDate:"",status:""},z()},Le=()=>{i.value={serino:"",customername:"",invoiceDate:"",status:""}},Me=(e,a)=>{x.confirm("确定要删除吗？",()=>{S.post("/Invoice/DeleteAll",V.stringify({id:e,type:a})).then(c=>{const v=c.success?"success":"error";x.msg(c.msg,v,!1),c.success&&ne()}).catch(c=>{})})},Re=async()=>{if(y.value==""){x.msg("请选择要开票的数据","warning",!1);return}q.value=!0,B.value.invoicedepartname=T.value.accountname,B.value.taxno=T.value.taxno;for(let e=0;e<y.value.length;e++){B.value.Id=y.value[e];try{await Oe()}catch{x.msg("开票失败","error",!1),M.value++}}};sa(k,e=>{L.value=Math.floor((k.value+M.value)/Number(y.value.length)*100),k.value>0,L.value===100&&setTimeout(()=>{q.value=!1},800)});const Oe=async()=>{const e=await S.post("/Invoice/OpenInvoice?srcorgid="+T.value.id,V.stringify(B.value));e.code==0?(k.value++,x.notify("第"+k.value+"张",e.msg,"success")):(M.value++,x.notify("",e.msg,"error"))},Ye=()=>{y.value=y.value.filter(e=>e!==B.value.id)},He=async()=>{try{const e=await S.post("user/GetUserInvoiceDepartByUser",V.stringify({userid:Se.value.userId}));e.success&&(De.value=e.data,ie.value=e.data[0].id)}catch{}},je=()=>{L.value=0,k.value=0,M.value=0,y.value=[],ne()},$e=e=>{r.value.size=e,z()},qe=e=>{f.value=0,m.value=0,r.value.number=e,z()},Ge=e=>{f.value=0,m.value=0,u.value.size=e,G()},Je=e=>{u.value.number=e,G()};function ue({row:e,column:a,rowIndex:c,columnIndex:v}){return{color:"#000",textAlign:"center"}}const de=t("");ia(null);const J=t(!1),Qe=e=>{U.value=e.id,A.value=e.billcode,P.value=e.serialNo,F.value=e.buyerTaxNo,E.value=e.buyerName,ke.value=e.invoiceTotalPrice,Ce.value=e.invoiceTotalTax,ze.value=e.invoiceTypeName,e.billcode=="手工开票"?Y.value=!0:Y.value=!1,de.value="修改",J.value=!0},We=e=>e<34?"#409eff":e<60?"#e6a23c":"#67c23a";return te("deleteid",Ye),te("getTableData",z),te("dialogShow",J),(e,a)=>{const c=d("el-button"),v=d("el-form-item"),ee=d("el-form"),D=d("el-table-column"),Xe=d("el-tag"),ce=d("el-table"),ve=d("el-pagination"),pe=d("el-input"),Ke=d("el-date-picker"),ge=d("el-option"),Ze=d("el-select"),ae=d("el-dialog"),ea=d("el-progress"),me=d("el-statistic"),aa=d("FullScreen"),la=d("el-icon"),fe=ra("loading");return g(),Q("div",null,[s("div",ca,[o(ee,{ref:"formbutton",inline:""},{default:n(()=>[o(v,null,{default:n(()=>[o(c,{style:{width:"100px"},type:"primary",onClick:Re},{default:n(()=>[p("开票")]),_:1})]),_:1}),o(v,null,{default:n(()=>[o(c,{type:"primary",onClick:Ee,icon:"Search"},{default:n(()=>[p("查询")]),_:1}),o(c,{type:"success",onClick:Be,icon:"Refresh"},{default:n(()=>[p("刷新")]),_:1})]),_:1}),o(v,{label:"开票单位",prop:"sobItemsName"},{default:n(()=>[p(N(T.value.accountname),1)]),_:1}),o(v,{label:"税号",prop:"sobTaxno"},{default:n(()=>[p(N(T.value.taxno),1)]),_:1})]),_:1},512)]),s("div",va,[_e((g(),C(ce,{data:K.value,stripe:r.value.tableStripe,border:"","highlight-current-row":r.value.tableHighlightCurrentRow,"max-height":"300",style:{width:"100%",color:"#000"},"header-cell-style":ue,onSelectionChange:Ue,onCurrentChange:Fe},{default:n(()=>[R("",!0),o(D,{type:"selection",width:"55",align:"center"}),(g(!0),Q(oe,null,he(Ve.value,(l,le)=>(g(),C(D,{fit:"","show-overflow-tooltip":"",key:le,prop:l.prop,label:l.label,align:l.align,width:l.width},null,8,["prop","label","align","width"]))),128)),o(D,{prop:"istatus",label:"开票状态",align:"center",width:"160"},{default:n(l=>[o(Xe,{effect:"light",type:Pe(l.row.istatus)},{default:n(()=>[p(N(l.row.istatus),1)]),_:2},1032,["type"])]),_:1}),o(D,{prop:"msg",label:"开票失败提示",align:"center",width:"170"}),o(D,{label:"操作",align:"center",width:"150",fixed:"right"},{default:n(l=>[l.row.istatus=="待开票"?(g(),C(c,{key:0,type:"primary",size:"small",onClick:le=>Qe(l.row)},{default:n(()=>[p("修改")]),_:2},1032,["onClick"])):R("",!0),o(c,{type:"danger",size:"small",onClick:le=>Me(l.row.id,l.row.billcode)},{default:n(()=>[p("删除")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","stripe","highlight-current-row"])),[[fe,I.value]])]),s("div",pa,[s("table",ga,[s("tr",null,[s("td",ma," 发票张数："+N(X.value)+"张 ",1),s("td",fa," 价税合计："+N(m.value)+"元 ",1),s("td",ba," 合计税额："+N(f.value)+"元 ",1)])])]),s("div",_a,[o(ve,{currentPage:r.value.number,"onUpdate:currentPage":a[0]||(a[0]=l=>r.value.number=l),"page-size":r.value.size,"onUpdate:pageSize":a[1]||(a[1]=l=>r.value.size=l),"page-sizes":r.value.sizes,background:r.value.background,layout:r.value.layout,total:r.value.total,disabled:b.value,onSizeChange:$e,onCurrentChange:qe},null,8,["currentPage","page-size","page-sizes","background","layout","total","disabled"])]),ha,s("div",ya,[_e((g(),C(ce,{data:Z.value,stripe:r.value.tableStripe,border:"","highlight-current-row":r.value.tableHighlightCurrentRow,"max-height":"300",style:{width:"100%",color:"#000"},"header-cell-style":ue,"default-sort":se.value},{default:n(()=>[(g(!0),Q(oe,null,he(Ie.value,l=>(g(),Q(oe,null,[l.show?(g(),C(D,{key:0,fit:"","show-overflow-tooltip":"",prop:l.prop,label:l.label,align:l.align,"min-width":l.width},null,8,["prop","label","align","min-width"])):R("",!0)],64))),256))]),_:1},8,["data","stripe","highlight-current-row","default-sort"])),[[fe,h.value]])]),s("div",wa,[o(ve,{currentPage:u.value.number,"onUpdate:currentPage":a[2]||(a[2]=l=>u.value.number=l),"page-size":u.value.size,"onUpdate:pageSize":a[3]||(a[3]=l=>u.value.size=l),"page-sizes":u.value.sizes,background:u.value.background,layout:u.value.layout,total:u.value.total,disabled:_.value,onSizeChange:Ge,onCurrentChange:Je},null,8,["currentPage","page-size","page-sizes","background","layout","total","disabled"])]),o(ae,{modelValue:j.value,"onUpdate:modelValue":a[8]||(a[8]=l=>j.value=l),title:"查询","align-center":"","destroy-on-close":"",width:"800px",draggable:"","close-on-click-modal":!1},{default:n(()=>[o(ee,{inline:!0,model:i.value,class:"inline","label-width":"100px"},{default:n(()=>[o(v,{label:"开票流水号"},{default:n(()=>[o(pe,{modelValue:i.value.serino,"onUpdate:modelValue":a[4]||(a[4]=l=>i.value.serino=l)},null,8,["modelValue"])]),_:1}),o(v,{label:"客户名称"},{default:n(()=>[o(pe,{modelValue:i.value.customername,"onUpdate:modelValue":a[5]||(a[5]=l=>i.value.customername=l)},null,8,["modelValue"])]),_:1}),o(v,{label:"开票日期"},{default:n(()=>[o(Ke,{modelValue:i.value.invoiceDate,"onUpdate:modelValue":a[6]||(a[6]=l=>i.value.invoiceDate=l),type:"daterange","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1}),o(v,{label:"开票状态"},{default:n(()=>[o(Ze,{modelValue:i.value.status,"onUpdate:modelValue":a[7]||(a[7]=l=>i.value.status=l),clearable:""},{default:n(()=>[o(ge,{label:"待开票",value:"待开票"}),o(ge,{label:"开票完成",value:"开票完成"})]),_:1},8,["modelValue"])]),_:1}),o(v,{style:{"margin-left":"30px"}},{default:n(()=>[o(c,{type:"primary",onClick:Ae},{default:n(()=>[p("查询")]),_:1}),o(c,{type:"success",onClick:Le},{default:n(()=>[p("重置")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(ae,{modelValue:q.value,"onUpdate:modelValue":a[9]||(a[9]=l=>q.value=l),top:"5vh",title:"完成进度","align-center":"",onClosed:je,"destroy-on-close":"",width:"600px",draggable:"","close-on-click-modal":!1},{default:n(()=>[o(ee,{style:{width:"100%"}},{default:n(()=>[s("div",xa,[s("div",Na,[o(ea,{"text-inside":!0,"stroke-width":20,color:We,percentage:L.value,striped:"","striped-flow":""},{default:n(()=>[Ta,s("span",null,N(L.value)+"%",1)]),_:1},8,["percentage"])]),s("div",ka,[s("div",Ca,[o(me,{value:k.value},{title:n(()=>[za]),suffix:n(()=>[p("/"+N(y.value.length)+"张",1)]),_:1},8,["value"])]),s("div",Da,[o(me,{value:M.value},{title:n(()=>[Sa]),suffix:n(()=>[p("张")]),_:1},8,["value"])])])])]),_:1})]),_:1},8,["modelValue"]),o(ae,{modelValue:J.value,"onUpdate:modelValue":a[21]||(a[21]=l=>J.value=l),title:de.value,onClose:a[22]||(a[22]=l=>H.value=!1),style:{position:"relative"},fullscreen:H.value,"align-center":"","destroy-on-close":"",width:"1450px",draggable:"","close-on-click-modal":!1},{default:n(()=>[Y.value?R("",!0):(g(),C(ye(xe),{key:0,id:U.value,"onUpdate:id":a[10]||(a[10]=l=>U.value=l),serialNo:P.value,"onUpdate:serialNo":a[11]||(a[11]=l=>P.value=l),buyerTaxNo:F.value,"onUpdate:buyerTaxNo":a[12]||(a[12]=l=>F.value=l),billcode:A.value,"onUpdate:billcode":a[13]||(a[13]=l=>A.value=l),buyerName:E.value,"onUpdate:buyerName":a[14]||(a[14]=l=>E.value=l)},null,8,["id","serialNo","buyerTaxNo","billcode","buyerName"])),Y.value?(g(),C(ye(Ne),{key:1,id:U.value,"onUpdate:id":a[15]||(a[15]=l=>U.value=l),serialNo:P.value,"onUpdate:serialNo":a[16]||(a[16]=l=>P.value=l),buyerTaxNo:F.value,"onUpdate:buyerTaxNo":a[17]||(a[17]=l=>F.value=l),billcode:A.value,"onUpdate:billcode":a[18]||(a[18]=l=>A.value=l),buyerName:E.value,"onUpdate:buyerName":a[19]||(a[19]=l=>E.value=l)},null,8,["id","serialNo","buyerTaxNo","billcode","buyerName"])):R("",!0),o(la,{onClick:a[20]||(a[20]=l=>H.value=!H.value),style:{position:"absolute",right:"45px",top:"24px",cursor:"pointer","font-size":"14px"}},{default:n(()=>[o(aa)]),_:1})]),_:1},8,["modelValue","title","fullscreen"])])}}});const Oa=ta(Va,[["__scopeId","data-v-d1b39fb3"]]);export{Oa as default};
