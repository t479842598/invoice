import{a as Ae,_ as Le}from"./index-823f4b27.js";import{d as je,ai as y,aT as a,b5 as qe,aF as Je,c as se,bF as ue,a as m,W as t,bD as o,H as re,b9 as V,aX as g,aY as Qe,o as E,U as d,I as Ge,F as He,aV as We,P as Xe,bi as Ke,Y as Ze,av as ea,bv as aa}from"./_@vue-5ba92de9.js";import{cC as de}from"./__vendor-5e6ac033.js";import"./_@element-plus-ad4c9002.js";import"./_crypto-js-0812dcff.js";import"./_element-plus-8c7ce171.js";import"./_@popperjs-c75af06c.js";import"./_pdfjs-dist-c04561eb.js";import"./_@microsoft-43c4e133.js";import"./_vue-codemirror-50da885a.js";const la={class:"form-container"},ta={class:"table-container"},oa={style:{display:"flex","align-items":"center"}},na=["onClick"],ia={class:"table-text"},sa={border:"0",class:"table",width:"900"},ua={width:"300",align:"center"},ra={width:"300",align:"center"},da={width:"300",align:"left"},ca={class:"roadui_pagerdiv"},va=je({__name:"invoiceQuery",props:{query:{type:String,default:()=>""}},setup(ma){const L=Ze(()=>Ae(()=>import("./completeView-23115943.js"),["./completeView-23115943.js","./_@vue-5ba92de9.js","./index-823f4b27.js","./__vendor-5e6ac033.js","./__vendor-693c365c.css","./_@element-plus-ad4c9002.js","./_crypto-js-0812dcff.js","./_element-plus-8c7ce171.js","./_@popperjs-c75af06c.js","./_element-plus-7d03f811.css","./_pdfjs-dist-c04561eb.js","./_@microsoft-43c4e133.js","./_vue-codemirror-50da885a.js","./index-2ccff9e2.css","./completeView-9efc00a8.css"],import.meta.url)),x=y("ajax"),p=y("utils"),ce=y("config"),D=y("qs");y("app"),y("index_openmenu"),y("index_removetab"),y("index_refreshtab");const ve=y("index_userinfo");y("submit_dialogshow");const k=a("");localStorage.getItem("sobInfo")!=""&&(k.value=JSON.parse(localStorage.getItem("sobInfo")));const me=a({prop:"invoiceDate",order:"ascending"}),pe=a({prop:"goodsLineNo",order:"ascending"}),r=a(p.getPager(me.value)),fe=a(p.getPager(pe.value)),S=a(!1),I=a(!1),U=a(!1),N=a(""),ge=a(""),be=a(""),j=a(),_e=a([]),q=a(""),ye=a("");a(!1),a(""),a(),a("");const F=a();a();const J=a(""),Y=a(""),Q=a(""),G=a(""),H=a(""),W=a(""),X=a(""),K=a(""),Z=a(""),ee=a(""),C=a(!1),ae=a(""),le=a(""),w=a({emailcode:""}),R=a(!1),f=a({no:"",invoiceDate:""}),B=a(0),b=a(0),_=a(0),te=a(""),we=qe(null),O=a(!1),P=a(!1);Je(()=>{Se(),Ne()});const he=a([{prop:"serialNo",label:"开票流水号",align:"center",width:"200",template:!0},{prop:"buyerName",label:"客户名称",align:"center",width:"245"},{prop:"sellerName",label:"销售方名称",align:"center",width:"245"},{prop:"buyerTaxNo",label:"税号",align:"center",width:"250"},{prop:"invoiceTotalPriceTax",label:"价税合计",align:"right",width:"100"},{prop:"invoiceTotalPrice",label:"无税金额",align:"right",width:"100"},{prop:"invoiceTotalTax",label:"税额",align:"center",width:"110"},{prop:"invoiceDate",label:"开票日期",align:"center",width:"200"},{prop:"invoiceNo",label:"发票号",align:"center",width:"220"}]),s=a({serino:"",invoiceno:"",customername:"",invoiceDate:"",status:""}),M=a([]);async function h(n){I.value=!0;try{n&&(r.value.number=1),s.value.date1=s.value.invoiceDate[0],s.value.date2=s.value.invoiceDate[1],s.value.pageSize=10,s.value.pageNo=1,s.value.Invoicedepartmentid=j.value;const e=await x.post("/invoice/SearchInvoice",D.stringify(s.value));if(e.data.total==0?S.value=!0:S.value=!1,e.data.rows.length>0){M.value=e.data.rows,B.value=e.data.total,N.value=e.data.rows[0].id,r.value.total=e.data.total,b.value=0,_.value=0;for(let i=0;i<e.data.rows.length;i++)b.value=Number((b.value+Number(e.data.rows[i].invoiceTotalPriceTax)).toFixed(2)),_.value=Number((_.value+Number(e.data.rows[i].invoiceTotalTax)).toFixed(2))}else{M.value=e.data.rows,B.value=e.data.total,N.value="0",r.value.total=e.data.total,b.value=0,_.value=0;for(let i=0;i<e.data.rows.length;i++)b.value=Number((b.value+Number(e.data.rows[i].invoiceTotalPriceTax)).toFixed(2)),_.value=Number((_.value+Number(e.data.rows[i].invoiceTotalTax)).toFixed(2))}}catch{S.value=!1,I.value=!1}finally{I.value=!1}}const xe=n=>{window.open(n)},De=(n,e,i,u,c,v)=>{Y.value=n,H.value=e,w.value.emailcode=e,Q.value=i,G.value=v.buyerName,q.value=u,J.value=c,W.value=v.buyerName,X.value=v.sellerName,K.value=v.invoiceNo,Z.value=v.invoiceDate,ee.value=v.invoiceTotalPriceTax,C.value=!0},Ve=(n,e,i,u)=>{if(!p.isEmail(n)){p.msg("邮箱格式不正确","error",!1);return}if(w.value.emailcode==""){p.msg("邮箱号码不能为空","error",!1);return}x.post("/Invoice/Send?srcorgid="+k.value.id,D.stringify({receiver:e,sendType:4,email:n,connid:i,id:u,ists:1,title:X.value+ae.value,contents:"尊敬的客户：<br>给您开具的数电发票下载链接为：<a href="+Y.value+">点击下载</a><br><br><br>购买方名称:"+W.value+"<br>发票号码: "+K.value+"<br>开具日期: "+Z.value+"<br>价税合计: ￥"+ee.value+"<br><br><br><br><hr>"+le.value})).then(c=>{Y.value="",H.value="",Q.value="";const v=c.code==0?"success":"error";c.code==0&&(C.value=!1,h(!0)),p.notify("",c.msg,v)}).catch(c=>{})};function $(){C.value=!1,R.value=!1,w.value.emailcode="",f.value.no="",f.value.invoiceDate=""}const ke=n=>{N.value=n,fe.value.number=1,we.value=L,te.value="明细查看",O.value=!0},Ne=()=>{x.post("Invoice/GetEmailModal?srcorgid="+k.value.id).then(n=>{ae.value=n.data.emailmodal.emailtitle,le.value=n.data.emailmodal.emailtext}).catch(n=>{})},Ce=()=>{U.value=!0},oe=()=>{de.debounce(()=>{_.value=0,b.value=0,s.value={serino:"",customername:"",invoiceDate:"",status:"开票完成"},h(!0)},300)()},Te=async()=>{try{const n=x.post("/SaleInvoice/UpdateInvoiceNo",D.stringify({id:ge.value,invoiceno:f.value.no,connid:ye.value,invoiceDate:f.value.invoiceDate})),e=x.post("/Invoice/UpdateInvoiceNo",D.stringify({id:be.value,invoiceno:f.value.no,invoiceDate:f.value.invoiceDate})),i=await Promise.all([n,e]);i[0].success&&i[1].success&&(p.msg(i[0].msg,"success",!1),p.msg(i[1].msg,"success",!1),h(!1),$())}catch(n){p.msg(n.message,"error",!1)}},Se=async()=>{try{const n=await x.post("user/GetUserInvoiceDepartByUser",D.stringify({userid:ve.value.userId}));n.success&&(_e.value=n.data,j.value=n.data[0].id)}catch{}},Ie=()=>{_.value=0,b.value=0,r.value.number=1,h(!0),U.value=!1},Ue=n=>{r.value.size=n,h(!1)},Pe=n=>{_.value=0,b.value=0,r.value.number=n,h(!1)};function ze({row:n,column:e,rowIndex:i,columnIndex:u}){return{color:"#000",textAlign:"center"}}const Ee=n=>{r.value.order=p.getOrder(n),h(!1)};function Fe(){s.value.date1=s.value.invoiceDate[0],s.value.date2=s.value.invoiceDate[1],ea(()=>{Ye()})}function Ye(){de.debounce(()=>{F.value.action=ce.SERVER_PRO_APIADDRESS+"/Report/ExportInvoiceMain?"+D.stringify({whereJSON:JSON.stringify(s.value)}),F.value.submit()},300)()}return(n,e)=>{const i=g("el-button"),u=g("el-form-item"),c=g("el-form"),v=g("el-table-column"),Re=g("el-table"),Be=g("el-pagination"),T=g("el-input"),ne=g("el-date-picker"),z=g("el-dialog"),Oe=g("FullScreen"),Me=g("el-icon"),$e=Qe("loading");return E(),se("div",null,[ue(m("form",{ref_key:"formref",ref:F,action:"",method:"post"},null,512),[[aa,!1]]),m("div",la,[t(c,{ref:"formbutton",inline:""},{default:o(()=>[t(u,null,{default:o(()=>[t(i,{type:"primary",onClick:Ce,icon:"Search"},{default:o(()=>[d("查询")]),_:1}),t(i,{type:"success",onClick:oe,icon:"Refresh"},{default:o(()=>[d("刷新")]),_:1}),t(i,{type:"warning",onClick:Fe,icon:"Upload"},{default:o(()=>[d("导出")]),_:1})]),_:1}),t(u,{label:"开票单位",prop:"sobItemsName"},{default:o(()=>[d(V(k.value.accountname),1)]),_:1}),t(u,{label:"税号",prop:"sobTaxno"},{default:o(()=>[d(V(k.value.taxno),1)]),_:1})]),_:1},512)]),m("div",ta,[ue((E(),re(Re,{data:M.value,stripe:r.value.tableStripe,border:"","highlight-current-row":r.value.tableHighlightCurrentRow,"max-height":"550",style:{width:"100%",color:"#000"},"header-cell-style":ze,onSortChange:Ee},{default:o(()=>[Ge("",!0),(E(!0),se(He,null,We(he.value,(l,A)=>(E(),re(v,{key:A,prop:l.prop,label:l.label,align:l.align,fit:"","show-overflow-tooltip":"",width:l.width},Xe({_:2},[l.template?{name:"default",fn:o(ie=>[m("div",oa,[m("a",{onClick:pa=>ke(ie.row.id),style:{"margin-left":"10px"}},V(ie.row.serialNo),9,na)])]),key:"0"}:void 0]),1032,["prop","label","align","width"]))),128)),t(v,{label:"操作",align:"center",width:"250",fixed:"right"},{default:o(l=>[t(i,{type:"primary",size:"small",onClick:A=>xe(l.row.eInvoiceUrl)},{default:o(()=>[d("下载电子版")]),_:2},1032,["onClick"]),t(i,{type:"success",size:"small",onClick:A=>De(l.row.eInvoiceUrl,l.row.buyerEmail,l.row.customercode,l.row.connid,l.row.id,l.row)},{default:o(()=>[d("发送客户邮箱")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","stripe","highlight-current-row"])),[[$e,I.value]])]),m("div",ia,[m("table",sa,[m("tr",null,[m("td",ua," 发票张数："+V(B.value)+"张 ",1),m("td",ra," 价税合计："+V(b.value)+"元 ",1),m("td",da," 合计税额："+V(_.value)+"元 ",1)])])]),m("div",ca,[t(Be,{currentPage:r.value.number,"onUpdate:currentPage":e[0]||(e[0]=l=>r.value.number=l),"page-size":r.value.size,"onUpdate:pageSize":e[1]||(e[1]=l=>r.value.size=l),"page-sizes":r.value.sizes,background:r.value.background,layout:r.value.layout,total:r.value.total,disabled:S.value,onSizeChange:Ue,onCurrentChange:Pe},null,8,["currentPage","page-size","page-sizes","background","layout","total","disabled"])]),t(z,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=l=>U.value=l),title:"查询","align-center":"","destroy-on-close":"",width:"800px",draggable:"","close-on-click-modal":!1},{default:o(()=>[t(c,{inline:!0,model:s.value,class:"inline","label-width":"100px"},{default:o(()=>[t(u,{label:"开票流水号"},{default:o(()=>[t(T,{modelValue:s.value.serino,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value.serino=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"发票号"},{default:o(()=>[t(T,{modelValue:s.value.invoiceno,"onUpdate:modelValue":e[3]||(e[3]=l=>s.value.invoiceno=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"客户名称"},{default:o(()=>[t(T,{modelValue:s.value.buyerName,"onUpdate:modelValue":e[4]||(e[4]=l=>s.value.buyerName=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"开票日期"},{default:o(()=>[t(ne,{modelValue:s.value.invoiceDate,"onUpdate:modelValue":e[5]||(e[5]=l=>s.value.invoiceDate=l),type:"daterange","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1}),t(u,{style:{"margin-left":"30px"}},{default:o(()=>[t(i,{type:"primary",onClick:Ie},{default:o(()=>[d("查询")]),_:1}),t(i,{type:"success",onClick:oe},{default:o(()=>[d("重置")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(z,{modelValue:C.value,"onUpdate:modelValue":e[9]||(e[9]=l=>C.value=l),title:"发送邮件","align-center":"","destroy-on-close":"",width:"500px"},{default:o(()=>[t(c,{model:w.value,class:"inline","label-width":"100px"},{default:o(()=>[t(u,{label:"邮箱号码"},{default:o(()=>[t(T,{modelValue:w.value.emailcode,"onUpdate:modelValue":e[7]||(e[7]=l=>w.value.emailcode=l),style:{width:"300px"}},null,8,["modelValue"])]),_:1}),t(u,null,{default:o(()=>[t(i,{type:"primary",onClick:e[8]||(e[8]=l=>Ve(w.value.emailcode,G.value,q.value,J.value))},{default:o(()=>[d("发送")]),_:1}),t(i,{type:"success",onClick:$},{default:o(()=>[d("取消")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(z,{modelValue:R.value,"onUpdate:modelValue":e[12]||(e[12]=l=>R.value=l),title:"发票号修改","align-center":"","destroy-on-close":"",width:"500px"},{default:o(()=>[t(c,{model:f.value,class:"inline","label-width":"100px"},{default:o(()=>[t(u,{label:"发票号"},{default:o(()=>[t(T,{modelValue:f.value.no,"onUpdate:modelValue":e[10]||(e[10]=l=>f.value.no=l),style:{width:"210px"}},null,8,["modelValue"])]),_:1}),t(u,{label:"开票日期"},{default:o(()=>[t(ne,{modelValue:f.value.invoiceDate,"onUpdate:modelValue":e[11]||(e[11]=l=>f.value.invoiceDate=l),type:"date","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1}),t(u,null,{default:o(()=>[t(i,{type:"primary",onClick:Te},{default:o(()=>[d("保存")]),_:1}),t(i,{type:"success",onClick:$},{default:o(()=>[d("取消")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(z,{modelValue:O.value,"onUpdate:modelValue":e[15]||(e[15]=l=>O.value=l),fullscreen:P.value,style:{position:"relative"},title:te.value,"align-center":"","destroy-on-close":"",width:"1300px",onClose:e[16]||(e[16]=l=>P.value=!1),draggable:"","close-on-click-modal":!1},{default:o(()=>[t(Ke(L),{id:N.value,"onUpdate:id":e[13]||(e[13]=l=>N.value=l)},null,8,["id"]),t(Me,{onClick:e[14]||(e[14]=l=>P.value=!P.value),style:{position:"absolute",right:"45px",top:"24px",cursor:"pointer","font-size":"14px"}},{default:o(()=>[t(Oe)]),_:1})]),_:1},8,["modelValue","fullscreen","title"])])}}});const ka=Le(va,[["__scopeId","data-v-57969c83"]]);export{ka as default};
