import{E as D,a as Ve}from"./_element-plus-8c7ce171.js";import{d as De,ai as x,aT as f,aF as Se,c as W,W as n,bD as v,A as Ye,aX as b,o as T,U,a as o,b9 as xe,F as Ue,aV as Ce,H as X,I as O,bi as Be,aP as Oe,aM as Ne}from"./_@vue-5ba92de9.js";import{_ as Fe}from"./index-823f4b27.js";import"./__vendor-5e6ac033.js";import"./_@element-plus-ad4c9002.js";import"./_@popperjs-c75af06c.js";import"./_crypto-js-0812dcff.js";import"./_pdfjs-dist-c04561eb.js";import"./_@microsoft-43c4e133.js";import"./_vue-codemirror-50da885a.js";const k=N=>(Oe("data-v-7e1612ec"),N=N(),Ne(),N),Ie={class:"custom-submit",style:{height:"72vh",overflow:"hidden","overflow-y":"scroll"}},Ee={border:"0",cellpadding:"1",cellspacing:"1",width:"890",class:"table"},Je=k(()=>o("td",{width:"100",class:"center"},"客户编号",-1)),Me=k(()=>o("td",{width:"100",class:"center"},"客户名称",-1)),Te={colspan:"3"},$e=k(()=>o("td",{width:"100",class:"center"},"状态",-1)),je=k(()=>o("td",{width:"100",class:"center"},"联系人",-1)),ze={width:"150"},Ge=k(()=>o("td",{width:"100",class:"center"},"联系电话",-1)),Ae={width:"150"},Pe=k(()=>o("td",{width:"100",class:"center"},"邮箱",-1)),qe={width:"150"},Re=k(()=>o("td",{width:"100",class:"center"},"业务员",-1)),He={width:"150"},Le=k(()=>o("td",{width:"100",class:"center"},"备注",-1)),We={colspan:"7"},Xe={border:"0",cellpadding:"1",cellspacing:"1",style:{"margin-left":"10px"},width:"900",class:"table"},Ke=k(()=>o("td",{width:"100",class:"center"},"开票单位",-1)),Qe={colspan:"3"};const Ze=k(()=>o("td",{width:"135",class:"center"},"纳税人识别号",-1)),et={colspan:"3"},tt=k(()=>o("td",{width:"100",class:"center"},"开票地址",-1)),at={width:"160"},lt=k(()=>o("td",{width:"120",class:"center"},"联系电话",-1)),ot={width:"160"},nt=k(()=>o("td",{width:"135",class:"center"},"开户银行",-1)),st={width:"160"},dt=k(()=>o("td",{width:"100",class:"center"},"银行账号",-1)),it={width:"160"},ut={style:{"margin-left":"10px"}},ct=De({__name:"Customsubmit",props:{modelValue:{type:Boolean,default:!1},id:{type:String,default:""},new:{type:Boolean,default:!1}},emits:["update:id","update:new"],setup(N,{emit:K}){const S=x("ajax"),Q=x("utils");x("config");const Y=x("qs");x("index_openmenu"),x("index_removetab");const $=x("index_refreshtab"),Z=x("submit_dialogshow"),ee=f({prop:"startDate",order:"ascending"}),te=f(Q.getPager(ee.value));f(!1);const P=f("");localStorage.getItem("sobInfo")!=""&&(P.value=JSON.parse(localStorage.getItem("sobInfo"))),new Date().toISOString().split("T")[0];const p=f([1]),C=f("1"),F=f("开票单位1"),j=f(""),ae=K,le=N;function q(e){return Ye({get:()=>le[e],set:t=>{ae(`update:${e}`,t)}})}const z=q("id"),R=q("new");Se(()=>{se(),R.value==!0?oe():ne()});const d=f({id:"",customercode:"",customername:"",customerlinker:"",customerphone:"",customeremail:"",customersalesperson:"",status:"",remarks:"",customersalespersoncode:"",OrganizeId:"",organname:"",userid:"",username:""}),a=f([{}]),s=f({1:[{id:"",invoicedepartid:"",customerid:"",billdate:"",servicestartdate:"",serviceenddate:""}]}),oe=()=>{S.post("/yun_customer/Get",Y.stringify({id:z.value})).then(e=>{d.value=e.data.customer,d.value.customersalesperson=d.value.customersalesperson,d.value.customersalespersoncode=d.value.userid,a.value[0].address=e.data.invoicedepartment[0].address,a.value[0].taxno=e.data.invoicedepartment[0].taxno,a.value[0].openbank=e.data.invoicedepartment[0].openbank,a.value[0].phone=e.data.invoicedepartment[0].phone,a.value[0].customerid=e.data.invoicedepartment[0].customerid,a.value[0].invoicedepartid=e.data.invoicedepartment[0].invoicedepartid,a.value[0].id=e.data.invoicedepartment[0].invoicedepartid,a.value[0].status=e.data.invoicedepartment[0].status,a.value[0].id=e.data.invoicedepartment[0].invoicedepartid,s.value=e.data.invoicedepartment[0].payrecords}).catch(()=>{})},ne=()=>{S.post("/yun_customer/Get",Y.stringify({id:z.value})).then(e=>{d.value=e.data.customer,d.value.customersalesperson=d.value.customersalesperson,d.value.customersalespersoncode=d.value.userid;for(let t=0;t<e.data.invoicedepartment.length;t++)a.value.push({id:"",customerid:"",invoicedepartid:"",invoicedepartname:"",taxno:"",address:"",phone:"",openbank:"",bankaccount:""}),a.value[t].id=e.data.invoicedepartment[t].invoicedepartid,a.value[t].customerid=e.data.invoicedepartment[t].customerid,a.value[t].invoicedepartid=e.data.invoicedepartment[t].invoicedepartid,a.value[t].taxno=e.data.invoicedepartment[t].taxno,a.value[t].address=e.data.invoicedepartment[t].address,a.value[t].phone=e.data.invoicedepartment[t].phone,a.value[t].openbank=e.data.invoicedepartment[t].openbank,a.value[t].bankaccount=e.data.invoicedepartment[t].bankaccount,a.value[t].invoicedepartname=e.data.invoicedepartment[t].invoicedepartname,p.value.push(t+2);H(),a.value.length>e.data.invoicedepartment.length&&p.value.splice(a.value.length-1,1),a.value[a.value.length-1].id===""&&a.value.splice(a.value.length-1,1)}).catch(()=>{})},H=()=>{const e=f("");S.post("/yun_customer/Get",Y.stringify({id:z.value})).then(t=>{for(let l=0;l<t.data.invoicedepartment.length;l++)e.value+=JSON.stringify(t.data.invoicedepartment[l].payrecords)+";";e.value=e.value.slice(0,-1),t.data.invoicedepartment.length>1?he(e.value):s.value=t.data.invoicedepartment[0].payrecords}).catch(()=>{})},L=f([]),se=()=>{S.post("Organize/GetTree?srcorgid="+P.value.id,Y.stringify({selecttype:"unit",keyword:""})).then(e=>{j.value=e.data[0].id,j.value!=""&&de()}).catch(()=>{})},de=()=>{S.post("Organize/GetUsersTree?parentid="+j.value,Y.stringify({selecttype:2})).then(e=>{L.value=e.data}).catch(()=>{})},ie=e=>{d.value.customersalespersoncode=e.id,d.value.customersalesperson=e.id,d.value.customersalespersonname=e.label},c=f(),J=(e,t,l)=>{S.post("/yun_customer/addpayrecords",Y.stringify({customerid:d.value.id,invoicedepartid:a.value[e-1].id})).then(m=>{c.value=m.data.payrecords[0],(c.value!=null||c.value!=null||c.value!=[]||c.value!="")&&ve(e,t,l)}).catch(()=>{})},ue=e=>{let t=!1;for(let l=0;l<p.value.length;l++)for(let m=0;m<s.value[p.value[l]].length;m++)if(JSON.stringify(s.value[p.value[l]][m])===JSON.stringify(e))if(m===0){s.value[p.value[l]][0].servicestartdate=null,s.value[p.value[l]][0].serviceenddate=null,D({type:"warning",message:"不能删除首行"});break}else{s.value[p.value[l]].splice(m,1),t=!0;break}t&&D({type:"success",message:"删除成功!"})},ce=()=>{Ve.confirm("确定删除客户信息?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{S.post("/yun_customer/DeleteAll",Y.stringify({id:d.value.id})).then(e=>{e.success?(D.success(e.msg),$()):(D.error(e.msg),$())}).catch(()=>{})}).catch(()=>{D({type:"info",message:"已取消删除"})})},y=f({id:"",customerid:"",invoicedepartid:"",invoicedepartname:"",taxno:"",address:"",phone:"",openbank:"",bankaccount:""}),G=f(),re=(e,t)=>{G.value=p.value.length+1,S.post("/yun_customer/addinvoicedepartment",Y.stringify({id:d.value.id,tabindex:G.value})).then(l=>{l.data.invoicedepartment[0].payrecords,y.value.id=l.data.invoicedepartment[0].invoicedepartid,y.value.customerid=l.data.invoicedepartment[0].customerid,y.value.invoicedepartid=l.data.invoicedepartment[0].invoicedepartid,y.value.invoicedepartname=l.data.invoicedepartment[0].invoicedepartname,y.value.taxno=l.data.invoicedepartment[0].taxno,y.value.address=l.data.invoicedepartment[0].address,y.value.phone=l.data.invoicedepartment[0].phone,y.value.openbank=l.data.invoicedepartment[0].openbank,y.value.bankaccount=l.data.invoicedepartment[0].bankaccount,C.value=(p.value.length+1).toString(),F.value="开票单位"+C.value,me(e,t)}).catch(()=>{})},ve=(e,t,l)=>{let m="",h=new Date,r="";t===4&&(s.value[e]=[{customerid:c.value.customerid,invoicedepartid:c.value.invoicedepartid,id:c.value.id,billdate:g(h),servicestartdate:r,serviceenddate:m,status:c.value.status}]);let w=new Date(s.value[e][s.value[e].length-1].serviceenddate),I=g(w);if(t===1)if(s.value[e][0].servicestartdate===""||s.value[e][0].servicestartdate===null){let _=new Date(s.value[e][0].billdate);_.setFullYear(_.getFullYear()+1),s.value[e][0].servicestartdate=g(h),s.value[e][0].serviceenddate=g(_)}else w.setFullYear(w.getFullYear()+1),s.value[e].push({customerid:c.value.customerid,invoicedepartid:c.value.invoicedepartid,id:c.value.id,billdate:g(h),servicestartdate:I,serviceenddate:g(w),status:c.value.status});else if(t===2)if(w.setFullYear(w.getFullYear()+2),s.value[e][0].servicestartdate===""||s.value[e][0].servicestartdate===null){let _=new Date(s.value[e][0].billdate);_.setFullYear(_.getFullYear()+2),s.value[e][0].servicestartdate=g(h),s.value[e][0].serviceenddate=g(_)}else s.value[e].push({customerid:c.value.customerid,invoicedepartid:c.value.invoicedepartid,id:c.value.id,billdate:g(h),servicestartdate:I,serviceenddate:g(w),status:c.value.status});else if(t===3)if(w.setFullYear(w.getFullYear()+3),s.value[e][0].servicestartdate===""||s.value[e][0].servicestartdate===null){let _=new Date(s.value[e][0].billdate);_.setFullYear(_.getFullYear()+3),s.value[e][0].servicestartdate=g(h),s.value[e][0].serviceenddate=g(_)}else s.value[e].push({customerid:c.value.customerid,invoicedepartid:c.value.invoicedepartid,id:c.value.id,billdate:g(h),servicestartdate:I,serviceenddate:g(w),status:c.value.status});function g(_){let B=_.getFullYear(),M=(_.getMonth()+1).toString().padStart(2,"0"),A=_.getDate().toString().padStart(2,"0");return`${B}-${M}-${A}`}(t==1||t==2||t==3)&&D({type:"success",message:"续费填写成功，请在表内继续操作！"}),l!==void 0&&s.value[e].splice(l,1)},pe=e=>{if(e.serviceenddate===""||e.serviceenddate===null||e.servicestartdate===""||e.servicestartdate===null){D({type:"warning",message:"请先填写服务开始日期和服务到期日期"});return}const t=f(0);S.post("/yun_customer/SavePayRecord",Y.stringify({paymentrecordsJSON:JSON.stringify(e)})).then(l=>{l.success?(t.value=1,D.success(l.data.paymentrecords[0].status)):(t.value=0,D.error(l.msg)),t.value==1&&H()}).catch(()=>{})},me=(e,t)=>{t==="add"?y.value!=""&&(p.value.push(p.value.length+1),F.value="开票单位"+C.value,a.value[a.value.length-1].id===""?(a.value[a.value.length-1].id=y.value.id,a.value[a.value.length-1].invoicedepartid=y.value.id,a.value[a.value.length-1].customerid=y.value.customerid):a.value.push(y.value),J(G.value,4)):t==="remove"&&(C.value=e.slice(4),C.value==e.slice(4)&&p.value.forEach((m,h)=>{if(m==e.slice(4))if(m==1){D({message:"第一个标签页不能删除",type:"warning"});return}else S.post("/yun_customer/DeleteInvoiceDepartment",Y.stringify({id:a.value[h].id})).then(r=>{r.code==-1?D.error(r.msg):(p.value.splice(h,1),a.value.splice(h,1),delete s.value[m],p.value.length>0&&(C.value=p.value[p.value.length-1].toString(),F.value="开票单位"+C.value))}).catch(()=>{})}))},_e=()=>{S.post("/yun_customer/save",Y.stringify({customerJSON:JSON.stringify(d.value),invoicedepartmentJSON:JSON.stringify(a.value),paymentrecordsJSON:JSON.stringify(s.value)})).then(e=>{e.success?(D.success(e.msg),$()):D.error(e.msg)})},fe=()=>{Z.value=!1},he=e=>{let t=e.split("};{");for(let l=0;l<t.length;l++){let m=l===0?t[l]+"}":l===t.length-1?"{"+t[l]:"{"+t[l]+"}",h=JSON.parse(m);Object.keys(h).forEach(r=>{s.value[r]=h[r]})}};function ge(e){}function ye({row:e,column:t,rowIndex:l,columnIndex:m}){return{color:"#000"}}return(e,t)=>{const l=b("el-button"),m=b("el-form-item"),h=b("el-form"),r=b("el-input"),w=b("el-option"),I=b("el-select"),g=b("el-tree-select"),_=b("el-card"),B=b("el-table-column"),M=b("el-date-picker"),A=b("el-popconfirm"),be=b("el-table"),ke=b("el-tab-pane"),we=b("el-tabs");return T(),W("div",Ie,[n(_,{class:"box-card",shadow:"never"},{default:v(()=>[n(h,{ref:"formbutton",inline:"","label-width":"120px"},{default:v(()=>[n(m,null,{default:v(()=>[n(l,{type:"primary",onClick:_e},{default:v(()=>[U("保存")]),_:1}),n(l,{type:"default",onClick:fe},{default:v(()=>[U("关闭")]),_:1}),n(l,{type:"danger",onClick:ce},{default:v(()=>[U("删除")]),_:1})]),_:1})]),_:1},512),o("table",Ee,[o("tbody",null,[o("tr",null,[Je,o("td",null,xe(d.value.customercode),1),Me,o("td",Te,[n(r,{modelValue:d.value.customername,"onUpdate:modelValue":t[0]||(t[0]=u=>d.value.customername=u)},null,8,["modelValue"])]),$e,o("td",null,[n(I,{style:{width:"160px"},modelValue:d.value.status,"onUpdate:modelValue":t[1]||(t[1]=u=>d.value.status=u),placeholder:"请选择"},{default:v(()=>[n(w,{label:"启用",value:"enabled"}),n(w,{label:"未启用",value:"disabled"})]),_:1},8,["modelValue"])])]),o("tr",null,[je,o("td",ze,[n(r,{modelValue:d.value.customerlinker,"onUpdate:modelValue":t[2]||(t[2]=u=>d.value.customerlinker=u)},null,8,["modelValue"])]),Ge,o("td",Ae,[n(r,{modelValue:d.value.customerphone,"onUpdate:modelValue":t[3]||(t[3]=u=>d.value.customerphone=u)},null,8,["modelValue"])]),Pe,o("td",qe,[n(r,{modelValue:d.value.customeremail,"onUpdate:modelValue":t[4]||(t[4]=u=>d.value.customeremail=u)},null,8,["modelValue"])]),Re,o("td",He,[n(g,{modelValue:d.value.customersalesperson,"onUpdate:modelValue":t[5]||(t[5]=u=>d.value.customersalesperson=u),class:"tree",clearable:"",filterable:"",data:L.value,onNodeClick:ie,"check-strictly":"true","render-after-expand":!1},null,8,["modelValue","data"])])]),o("tr",null,[Le,o("td",We,[n(r,{type:"textarea",autosize:"",modelValue:d.value.remarks,"onUpdate:modelValue":t[6]||(t[6]=u=>d.value.remarks=u)},null,8,["modelValue"])])])])])]),_:1}),n(we,{modelValue:F.value,"onUpdate:modelValue":t[7]||(t[7]=u=>F.value=u),onTabClick:ge,type:"card",editable:"",onEdit:re},{default:v(()=>[(T(!0),W(Ue,null,Ce(p.value,(u,V)=>(T(),X(ke,{key:V,label:"开票单位"+u,name:"开票单位"+u},{default:v(()=>[o("table",Xe,[o("tbody",null,[o("tr",null,[Ke,o("td",Qe,[O("",!0),O("",!0),O("",!0),n(r,{modelValue:a.value[V].invoicedepartname,"onUpdate:modelValue":i=>a.value[V].invoicedepartname=i},null,8,["modelValue","onUpdate:modelValue"])]),Ze,o("td",et,[n(r,{modelValue:a.value[V].taxno,"onUpdate:modelValue":i=>a.value[V].taxno=i},null,8,["modelValue","onUpdate:modelValue"])])]),o("tr",null,[tt,o("td",at,[n(r,{modelValue:a.value[V].address,"onUpdate:modelValue":i=>a.value[V].address=i},null,8,["modelValue","onUpdate:modelValue"])]),lt,o("td",ot,[n(r,{modelValue:a.value[V].phone,"onUpdate:modelValue":i=>a.value[V].phone=i},null,8,["modelValue","onUpdate:modelValue"])]),nt,o("td",st,[n(r,{modelValue:a.value[V].openbank,"onUpdate:modelValue":i=>a.value[V].openbank=i},null,8,["modelValue","onUpdate:modelValue"])]),dt,o("td",it,[n(r,{modelValue:a.value[V].bankaccount,"onUpdate:modelValue":i=>a.value[V].bankaccount=i},null,8,["modelValue","onUpdate:modelValue"])])])])]),o("div",ut,[n(l,{type:"primary",onClick:i=>J(u,1)},{default:v(()=>[U("续费一年")]),_:2},1032,["onClick"]),n(l,{type:"primary",onClick:i=>J(u,2)},{default:v(()=>[U("续费两年")]),_:2},1032,["onClick"]),n(l,{type:"primary",onClick:i=>J(u,3)},{default:v(()=>[U("续费三年")]),_:2},1032,["onClick"])]),n(be,{data:s.value[u],stripe:te.value.tableStripe,border:"","max-height":"235",style:{width:"98%",color:"#000",margin:"10px auto"},"header-cell-style":ye},{default:v(()=>[O("",!0),O("",!0),O("",!0),n(B,{prop:"billdate",label:"续费日期",align:"center"}),n(B,{prop:"servicestartdate",label:"服务开始日期",align:"center"},{default:v(i=>[n(M,{style:{width:"100%"},modelValue:i.row.servicestartdate,"onUpdate:modelValue":E=>i.row.servicestartdate=E,type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),n(B,{prop:"serviceenddate",label:"服务到期日期",align:"center"},{default:v(i=>[n(M,{style:{width:"100%"},modelValue:i.row.serviceenddate,"onUpdate:modelValue":E=>i.row.serviceenddate=E,type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),n(B,{prop:"status",label:"状态",align:"center"}),n(B,{label:"操作"},{default:v(i=>[Be(R)?O("",!0):(T(),X(l,{key:0,size:"small",type:"warning",onClick:E=>pe(i.row)},{default:v(()=>[U("续费")]),_:2},1032,["onClick"])),n(A,{onConfirm:E=>ue(i.row),title:"确定删除该行吗?"},{reference:v(()=>[n(l,{size:"small",type:"danger"},{default:v(()=>[U("删除")]),_:1})]),_:2},1032,["onConfirm"])]),_:1})]),_:2},1032,["data","stripe"])]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])])}}});const kt=Fe(ct,[["__scopeId","data-v-7e1612ec"]]);export{kt as default};
