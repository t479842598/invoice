import{e as ee}from"./excel-1d8df660.js";import{cC as oe}from"./__vendor-5e6ac033.js";import{d as te,ai as r,aT as a,aF as ae,by as le,c as D,W as l,bD as t,a as c,bF as ne,H as F,au as se,aX as i,aY as re,o as y,U as g,b9 as T,I as M,F as ie,aV as ce}from"./_@vue-5ba92de9.js";import"./_element-plus-8c7ce171.js";import"./_@element-plus-ad4c9002.js";import"./_@popperjs-c75af06c.js";const ue={class:"table-container"},de={style:{margin:"auto",width:"80%"}},pe=c("span",null,"正在开票中",-1),ge={style:{"margin-top":"10px",margin:"10px auto",display:"flex","justify-content":"space-around"}},he={class:"successfa"},me=c("div",{style:{display:"inline-flex","align-items":"center","font-size":"14px"}}," 已开票 ",-1),fe={class:"errorfa"},_e=c("div",{style:{display:"inline-flex","align-items":"center","font-size":"14px"}}," 开票失败 ",-1),Se=te({__name:"importExcel",setup(ve){const P=r("ajax"),h=r("utils");r("config");const B=r("qs"),j=r("index_openmenu"),O=r("index_removetab");r("index_refreshtab");const A=r("index_userinfo"),v=a("");localStorage.getItem("sobInfo")!=""&&(v.value=JSON.parse(localStorage.getItem("sobInfo")));const E=a({prop:"goodsLineNo",order:"ascending"}),U=a(h.getPager(E.value));r("importshow");const J=a(!1),N=a(!1),L=a(),R=a([]),S=a([]);ae(async()=>{await W()});const q=a([{prop:"serialNo",label:"开票流水号",align:"center",width:"200"},{prop:"buyerName",label:"客户名称",align:"center",width:"250"},{prop:"buyerTaxNo",label:"税号",align:"center",width:"200"},{prop:"invoiceTotalPriceTax",label:"含税总金额",align:"right",width:"100"},{prop:"invoiceTotalPrice",label:"无税总金额",align:"right",width:"100"},{prop:"invoiceTotalTax",label:"税额",align:"center",width:"110"},{prop:"remarks",label:"备注",align:"center",width:"110"},{prop:"goodsCode",label:"税收分类编码",show:!0,align:"center",width:"200"},{prop:"goodsName",label:"商品名称",show:!0,align:"center",width:"160"},{prop:"goodsSpecification",label:"规格型号",show:!0,align:"center",width:"180"},{prop:"goodsUnit",label:"单位",show:!0,align:"center",width:"100"},{prop:"goodsQuantity",label:"数量",show:!0,align:"center",width:"120"},{prop:"goodsPrice",label:"单价",show:!0,align:"center",width:"120"},{prop:"goodsTotalPrice",label:"价税合计",show:!0,align:"right",width:"120"},{prop:"notaxamount",label:"无税金额",show:!0,align:"right",width:"120"},{prop:"goodsTaxRate",label:"税率(%)",show:!0,align:"center",width:"150"},{prop:"goodsTotalTax",label:"税额",show:!0,align:"center"}]),m=a([]);a({Id:"",invoicedepartname:"",taxno:""});const b=a(0),w=a(0),V=a(0),z=e=>{S.value=Array.from(new Set(e.map(n=>n.id)))};le(b,e=>{w.value=Math.floor((b.value+V.value)/Number(S.value.length)*100),b.value>0,w.value===100&&setTimeout(()=>{N.value=!1},800)});const k=a(),H=e=>{k.value.clearFiles();const n=e[0];k.value.handleStart(n)},Q=e=>{ee(e.raw).then(n=>{m.value.length=0,n.forEach(o=>{m.value.push({serialNo:o.开票流水号,buyerName:o.客户名称,buyerTaxNo:o.税号,invoiceTotalPriceTax:o.含税总金额,invoiceTotalPrice:o.无税总金额,invoiceTotalTax:o.税额,remarks:o.备注,goodsCode:o.税收分类编码,goodsName:o.商品名称,goodsSpecification:o.规格型号,goodsUnit:o.单位,goodsQuantity:o.数量,goodsPrice:o.单价,goodsTotalPrice:o.价税合计,notaxamount:o.无税金额,goodsTaxRate:o["税率(%)"],goodsTotalTax:o.税额})})})};function $(e){return e.type!=="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"&&e.type!=="application/vnd.ms-excel"?(h.msg("要导入的文件必须是excel格式文件!",!1),!1):!0}function G(){oe.debounce(()=>{if(m.value.length==0){h.msg("请先导入数据!",!1);return}P.post("/Invoice/SaveExcel?srcorgid="+v.value.id,B.stringify({excelJSON:JSON.stringify(m.value)})).then(e=>{e.success?(h.msg(e.msg,!0),O(),j({id:"492732745289797",title:"开票任务列表",closable:!0,componentId:"492732745289797",height:0,ico:"Tickets",icoColor:"",openMode:0,parentId:"485253976780869",scopedSlots:{icon:"custom"},title_en:"Menus",title_tw:"菜單",url:"/Invoice/tasklist",width:0})):h.msg(e.msg,!1)})},300)()}const W=async()=>{try{const e=await P.post("user/GetUserInvoiceDepartByUser",B.stringify({userid:A.value.userId}));e.success&&(R.value=e.data,L.value=e.data[0].id)}catch{}},X=e=>{const{columns:n,data:o}=e,s=[],I=["goodsTotalPrice","goodsTotalTax","notaxamount"];return n.forEach((f,u)=>{if(u===0){s[u]="合计";return}if(I.includes(f.property)){const x=o.map(d=>Number(d[f.property]));x.every(d=>Number.isNaN(d))?s[u]="":s[u]=` ${x.reduce((d,_)=>{const C=Number(_);return Number.isNaN(C)?d:d+_},0)}`}else s[u]=""}),s};function Y({row:e,column:n,rowIndex:o,columnIndex:s}){return{color:"#000",textAlign:"center"}}return(e,n)=>{const o=i("el-button"),s=i("el-form-item"),I=i("el-upload"),f=i("el-form"),u=i("el-table-column"),x=i("el-table"),d=i("el-progress"),_=i("el-statistic"),C=i("el-dialog"),K=re("loading");return y(),D("div",null,[l(f,{ref:"formbutton",inline:""},{default:t(()=>[l(s,{style:{"margin-right":"15px"}},{default:t(()=>[l(o,{icon:"Select",type:"primary",onClick:G},{default:t(()=>[g("保存")]),_:1})]),_:1}),l(s,null,{default:t(()=>[l(I,{ref_key:"upload",ref:k,limit:1,style:{"margin-right":"15px","margin-bottom":"2px"},"on-change":Q,"on-exceed":H,accept:".xlsx,.xls","auto-upload":!1,"before-upload":$,"show-file-list":!1},{trigger:t(()=>[l(o,{icon:"Upload",type:"warning"},{default:t(()=>[g("导入Excel")]),_:1})]),_:1},512)]),_:1}),l(s,{label:"开票单位",prop:"sobItemsName"},{default:t(()=>[g(T(v.value.accountname),1)]),_:1}),l(s,{label:"税号",prop:"sobTaxno"},{default:t(()=>[g(T(v.value.taxno),1)]),_:1})]),_:1},512),c("div",ue,[ne((y(),F(x,se({data:m.value,"summary-method":X,"show-summary":"",stripe:U.value.tableStripe,border:"","highlight-current-row":U.value.tableHighlightCurrentRow,"max-height":"600",style:{width:"100%",color:"#000"},"header-cell-style":Y,onSelectionChange:z},e.$attrs,{"default-sort":E.value}),{default:t(()=>[M("",!0),l(u,{type:"selection",width:"55",align:"center"}),M("",!0),(y(!0),D(ie,null,ce(q.value,(p,Z)=>(y(),F(u,{key:Z,prop:p.prop,label:p.label,align:p.align,width:p.width},null,8,["prop","label","align","width"]))),128))]),_:1},16,["data","stripe","highlight-current-row","default-sort"])),[[K,J.value]])]),l(C,{modelValue:N.value,"onUpdate:modelValue":n[0]||(n[0]=p=>N.value=p),top:"5vh",title:"完成进度","align-center":"",onClosed:e.taskclose,"destroy-on-close":"",width:"600px",draggable:"","close-on-click-modal":!1},{default:t(()=>[l(f,{style:{width:"100%"}},{default:t(()=>[c("div",de,[l(d,{"text-inside":!0,"stroke-width":18,color:e.customColorMethod,percentage:w.value,striped:"","striped-flow":""},{default:t(()=>[pe,c("span",null,T(w.value)+"%",1)]),_:1},8,["color","percentage"]),c("div",ge,[c("div",he,[l(_,{value:b.value},{title:t(()=>[me]),suffix:t(()=>[g("/"+T(S.value.length)+"张",1)]),_:1},8,["value"])]),c("div",fe,[l(_,{value:V.value},{title:t(()=>[_e]),suffix:t(()=>[g("张")]),_:1},8,["value"])])])])]),_:1})]),_:1},8,["modelValue","onClosed"])])}}});export{Se as default};
