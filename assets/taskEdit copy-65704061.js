import{S as ue,P as ce}from"./_@element-plus-ad4c9002.js";import"./__vendor-5e6ac033.js";import{_ as pe}from"./index-823f4b27.js";import{a as F}from"./_element-plus-8c7ce171.js";import{ai as m,aT as r,aF as me,by as ge,c as S,W as n,bD as u,a as e,b9 as x,bF as he,H as B,A as ve,aX as N,aY as fe,o as v,bi as E,U as V,F as L,aV as _e,I as be,aP as ye,aM as Te}from"./_@vue-5ba92de9.js";import"./_crypto-js-0812dcff.js";import"./_pdfjs-dist-c04561eb.js";import"./_@microsoft-43c4e133.js";import"./_vue-codemirror-50da885a.js";import"./_@popperjs-c75af06c.js";const s=f=>(ye("data-v-db689cb2"),f=f(),Te(),f),we={border:"0",style:{"margin-left":"20px"},cellpadding:"1",cellspacing:"1","min-width":"1200",class:"table"},xe=s(()=>e("td",{width:"120",class:"center"},"开票流水号",-1)),Ne={width:"220"},Ve=s(()=>e("td",{width:"120",class:"center"},"客户名称",-1)),Pe={width:"220"},Se=s(()=>e("td",{width:"125",class:"center"},"纳税人识别号",-1)),ke={width:"220"},Ie=s(()=>e("td",{width:"120",class:"center"},"单位地址",-1)),Be={width:"220"},De=s(()=>e("td",{width:"100",class:"center"},"含税金额",-1)),Ue={width:"220"},Ae=s(()=>e("td",{width:"120",class:"center"},"税额",-1)),Ce={width:"220"},Fe=s(()=>e("td",{width:"125",class:"center"},"无税金额",-1)),Ee={width:"220"},Le=s(()=>e("td",{width:"100",class:"center"},"银行账户",-1)),Re={width:"220"},Oe=s(()=>e("td",{width:"100",class:"center"},"原单据含税金额",-1)),Je={width:"220"},Me=s(()=>e("td",{width:"120",class:"center"},"原单据税额",-1)),Qe={width:"220"},je=s(()=>e("td",{width:"125",class:"center"},"原单据无税金额",-1)),qe={width:"220"},Ge=s(()=>e("td",{width:"120",class:"center"},"开户银行",-1)),He={width:"220"},We=s(()=>e("td",{width:"125",class:"center"},"备注",-1)),ze={colspan:"3"},Xe=s(()=>e("td",{width:"125",class:"center"},"邮箱",-1)),Ye={width:"220"},$e=s(()=>e("td",{width:"125",class:"center"},"联系电话",-1)),Ke={width:"220"},Ze={style:{display:"flex",width:"35%","justify-content":"space-around","vertical-align":"bottom"}},et=s(()=>e("h3",{class:"before"},"发票明细",-1)),tt={class:"table-container"},ot={key:1},at={__name:"taskEdit copy",props:{query:{type:String,default:()=>""},modelValue:{type:Boolean,default:!1},id:{type:String,default:""},serialNo:{type:String,default:""},buyerTaxNo:{type:String,default:""},buyerName:{type:String,default:""},invoiceTotalPrice:{type:String,default:""},invoiceTotalTax:{type:String,default:""},billcode:{type:String,default:""}},emits:["update:id","update:serialNo","update:buyerTaxNo","update:buyerName","update:invoiceTotalPrice","update:invoiceTotalTax","update:billcode"],setup(f,{expose:R,emit:O}){const _=m("ajax"),c=m("utils"),b=m("qs");m("config");const J=m("getTableData");m("postSaleDetail");const M=m("dialogShow"),Q=m("index_refreshtab"),D=r({prop:"goodsLineNo",order:"ascending"}),k=r("");localStorage.getItem("sobInfo")!=""&&(k.value=JSON.parse(localStorage.getItem("sobInfo")));const U=r(c.getPager(D.value));r(!1);const y=r(!1),A=r([]);me(()=>{Z(),ee()});const j=O,q=f;function g(t){return ve({get:()=>q[t],set:o=>{j(`update:${t}`,o)}})}const T=g("id"),G=g("serialNo"),H=g("buyerTaxNo"),W=g("buyerName"),z=g("invoiceTotalPrice"),X=g("invoiceTotalTax"),Y=g("billcode"),l=r({id:"",serialNo:"",buyerTaxNo:"",buyerName:"",invoiceTotalPrice:"",invoiceTotalTax:"",buyerPhone:"",buyerAddress:"",buyerBankAccount:"",buyerBankName:"",remarks:""}),$=r([{prop:"id",align:"center",show:!1,useTemplate:!1},{prop:"goodsLineNo",label:"序号",align:"center",useTemplate:!1,show:!1,width:"60"},{prop:"goodsCode",label:"商品编号",show:!0,useTemplate:!0,align:"center",width:"200"},{prop:"goodsName",label:"商品名称",show:!0,useTemplate:!0,align:"center",width:"160"},{prop:"goodsSpecification",label:"规格型号",show:!0,useTemplate:!0,align:"center",width:"180"},{prop:"goodsUnit",label:"单位",show:!0,align:"center",useTemplate:!0,width:"100"},{prop:"goodsQuantity",label:"数量",show:!0,align:"center",useTemplate:!0,width:"120"},{prop:"goodsPrice",label:"单价",show:!0,align:"center",useTemplate:!1,width:"120"},{prop:"goodsTotalPrice",label:"价税合计",show:!0,align:"right",useTemplate:!0,width:"120"},{prop:"notaxamount",label:"无税金额",show:!0,align:"right",useTemplate:!1,width:"120"},{prop:"goodsTotalTax",label:"税额",show:!0,useTemplate:!0,align:"center",width:"150"},{prop:"goodsTaxRate",label:"税率/征收率",show:!0,align:"center",useTemplate:!1,minWidth:"150%"},{prop:"invoiceLineNature",label:"发票行性质",show:!1,align:"center",useTemplate:!0,width:"200"},{prop:"discountRate",label:"折扣率",show:!1,align:"center",useTemplate:!0,width:"200"},{prop:"discountAmount",label:"折扣额",show:!1,align:"center",useTemplate:!0,width:"200"}]);function K(){l.value={id:T.value,serialNo:G.value,buyerTaxNo:H.value,buyerName:W.value,invoiceTotalPrice:z.value,invoiceTotalTax:X.value}}const Z=async()=>{y.value=!0;try{const t=await _.post("/Invoice/GetInvoiceDetailMainNoPageList",b.stringify({id:T.value}));p.value=t.data.rows}catch(t){c.msg(t.message,"error",!1)}finally{y.value=!1}},ee=async()=>{y.value=!0;try{const t=await _.post("/Invoice/Get",b.stringify({ids:T.value}));Array.isArray(t.data.invoicemain)&&t.data.invoicemain.length>0&&(l.value=t.data.invoicemain[0])}catch{}finally{y.value=!1}};function te(){_.post("/invoice/GetInvoiceDetailHB?srcorgid="+k.value.id,b.stringify({id:T.value})).then(t=>{if(t.success)c.msg("合并成功","success",!1),p.value=t.data.rows;else{c.msg(t.msg,"error",!1);return}}).catch(()=>{})}function oe(){const t={id:c.getLongId(),goodsLineNo:"",goodsName:"",goodsSpecification:"",goodsUnit:"",goodsQuantity:"",goodsPrice:"0",goodsTotalPrice:"",goodsTaxRate:"",goodsTotalTax:"",invoiceLineNature:1,discountRate:"",discountAmount:""};p.value.push(t)}function ae(){const t=A.value;if(t.length===0){c.msg("请选择要删除的行","warning",!1);return}for(let o=0;o<t.length;o++){const d=p.value.indexOf(t[o]);p.value.splice(d,1)}}function le(){F.confirm("确定要保存吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{_.post("/Invoice/Save?srcorgid="+k.value.id,b.stringify({invoiceJSON:JSON.stringify(l.value),invoicedetailsJSON:JSON.stringify(p.value)})).then(t=>{const o=t.success?"success":"error";c.msg(t.msg,o,!1),t.success&&(J(),M.value=!1)}).catch(()=>{})}).catch(()=>{})}function ie(){F.confirm("确定要作废吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{_.post("/Invoice/DeleteAll",b.stringify({id:T.value,type:Y.value})).then(t=>{const o=t.success?"success":"error";c.msg(t.msg,o,!1),t.success&&Q()}).catch(()=>{})}).catch(()=>{})}const ne=t=>{A.value=t},p=r([]);function C({row:t,column:o,rowIndex:d,columnIndex:h}){return{color:"#000",textAlign:"center"}}function se({row:t}){if(t.goodsTotalPrice===0)return{backgroundColor:"yellow"}}return ge(()=>p.value,t=>{let o=0,d=0;const h=r(0);t.forEach(i=>{if(o+=Number(i.goodsTotalPrice),d+=Number(i.goodsTotalTax),i.goodsQuantity==""||i.goodsQuantity==null)i.goodsPrice=0;else{let P=(Number(i.goodsTotalPrice)/Number(i.goodsQuantity)).toFixed(8);i.goodsPrice=isNaN(P)?0:P}const w=1+Number(i.goodsTaxRate)/100;h.value=(Number(i.goodsTotalPrice)/Number(w)).toFixed(2),i.goodsTotalTax=(Number(i.goodsTotalPrice)-h.value).toFixed(2),i.notaxamount=h.value}),l.value.invoiceTotalPriceTax=Number(o.toFixed(2)),l.value.invoiceTotalTax=Number(d.toFixed(2))},{deep:!0}),R({open:K,headerCellStyle:C}),(t,o)=>{const d=N("el-button"),h=N("el-form-item"),i=N("el-input"),w=N("el-table-column"),P=N("el-table"),de=fe("loading");return v(),S("div",null,[n(h,null,{default:u(()=>[n(d,{icon:E(ue),type:"primary",onClick:le},{default:u(()=>[V("保存")]),_:1},8,["icon"]),n(d,{icon:E(ce),type:"danger",onClick:ie},{default:u(()=>[V("作废")]),_:1},8,["icon"])]),_:1}),e("table",we,[e("tbody",null,[e("tr",null,[xe,e("td",Ne,x(l.value.serialNo),1),Ve,e("td",Pe,[n(i,{modelValue:l.value.buyerName,"onUpdate:modelValue":o[0]||(o[0]=a=>l.value.buyerName=a)},null,8,["modelValue"])]),Se,e("td",ke,[n(i,{modelValue:l.value.buyerTaxNo,"onUpdate:modelValue":o[1]||(o[1]=a=>l.value.buyerTaxNo=a)},null,8,["modelValue"])]),Ie,e("td",Be,[n(i,{modelValue:l.value.buyerAddress,"onUpdate:modelValue":o[2]||(o[2]=a=>l.value.buyerAddress=a)},null,8,["modelValue"])])]),e("tr",null,[De,e("td",Ue,[n(i,{modelValue:l.value.invoiceTotalPriceTax,"onUpdate:modelValue":o[3]||(o[3]=a=>l.value.invoiceTotalPriceTax=a)},null,8,["modelValue"])]),Ae,e("td",Ce,[n(i,{modelValue:l.value.invoiceTotalTax,"onUpdate:modelValue":o[4]||(o[4]=a=>l.value.invoiceTotalTax=a)},null,8,["modelValue"])]),Fe,e("td",Ee,[n(i,{modelValue:l.value.invoiceTotalPrice,"onUpdate:modelValue":o[5]||(o[5]=a=>l.value.invoiceTotalPrice=a)},null,8,["modelValue"])]),Le,e("td",Re,[n(i,{modelValue:l.value.buyerBankAccount,"onUpdate:modelValue":o[6]||(o[6]=a=>l.value.buyerBankAccount=a)},null,8,["modelValue"])])]),e("tr",null,[Oe,e("td",Je,x(l.value.oldinvoiceTotalPriceTax),1),Me,e("td",Qe,x(l.value.oldinvoiceTotalTax),1),je,e("td",qe,x(l.value.oldinvoiceTotalPrice),1),Ge,e("td",He,[n(i,{modelValue:l.value.buyerBankName,"onUpdate:modelValue":o[7]||(o[7]=a=>l.value.buyerBankName=a)},null,8,["modelValue"])])]),e("tr",null,[We,e("td",ze,[n(i,{type:"textarea",autosize:"",modelValue:l.value.remarks,"onUpdate:modelValue":o[8]||(o[8]=a=>l.value.remarks=a)},null,8,["modelValue"])]),Xe,e("td",Ye,[n(i,{modelValue:l.value.buyerEmail,"onUpdate:modelValue":o[9]||(o[9]=a=>l.value.buyerEmail=a)},null,8,["modelValue"])]),$e,e("td",Ke,[n(i,{modelValue:l.value.buyerPhone,"onUpdate:modelValue":o[10]||(o[10]=a=>l.value.buyerPhone=a)},null,8,["modelValue"])])])])]),e("div",Ze,[et,n(h,{style:{"padding-top":"10px"}},{default:u(()=>[n(d,{type:"warning",onClick:te},{default:u(()=>[V("合并明细行")]),_:1}),n(d,{type:"primary",onClick:oe},{default:u(()=>[V("添加折扣行")]),_:1}),n(d,{type:"danger",onClick:ae},{default:u(()=>[V("删除行")]),_:1})]),_:1})]),e("div",tt,[he((v(),B(P,{data:p.value,stripe:U.value.tableStripe,border:"","highlight-current-row":U.value.tableHighlightCurrentRow,"max-height":"400",style:{width:"100%",color:"#000"},"header-cell-style":C,"default-sort":D.value,onSelectionChange:ne,"row-style":se},{default:u(()=>[n(w,{type:"index",width:"50",align:"center"}),n(w,{type:"selection",width:"55",align:"center"}),(v(!0),S(L,null,_e($.value,a=>(v(),S(L,null,[a.show?(v(),B(w,{key:0,prop:a.prop,"min-width":a.minWidth,label:a.label,align:a.align,width:a.width},{default:u(I=>[a.useTemplate?(v(),B(i,{key:0,modelValue:I.row[a.prop],"onUpdate:modelValue":re=>I.row[a.prop]=re},null,8,["modelValue","onUpdate:modelValue"])):(v(),S("span",ot,x(I.row[a.prop]),1))]),_:2},1032,["prop","min-width","label","align","width"])):be("",!0)],64))),256))]),_:1},8,["data","stripe","highlight-current-row","default-sort"])),[[de,y.value]])])])}}},gt=pe(at,[["__scopeId","data-v-db689cb2"]]);export{gt as default};
